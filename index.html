<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>FLASH6 - DASHBOARD</title>

  <!-- ✅ 이미지 프리로드(LOCKOUT/토스트/아이콘 늦게 뜨는거 방지) -->
  <link rel="preload" as="image" href="img/Flash_logo.png">
  <link rel="preload" as="image" href="img/Danger.svg">
  <link rel="preload" as="image" href="img/Tick.svg">
  <link rel="preload" as="image" href="img/Graph.svg">
  <link rel="preload" as="image" href="img/Activity.svg">
  <link rel="preload" as="image" href="img/RS_1.svg">
  <link rel="preload" as="image" href="img/RS_2.svg">
  <link rel="preload" as="image" href="img/RS_all.svg">

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f3f4f6;--bg-soft:#e5e7eb;
      --card-bg:rgba(255,255,255,0.96);
      --card-glass-border-outer:rgba(255,255,255,0.95);
      --card-glass-border-inner:rgba(148,163,184,0.88);
      --card-shadow:0 18px 40px rgba(15,23,42,0.12);
      --text-main:#0f172a;--text-soft:#6b7280;--text-mono:#374151;
      --accent:#2563eb;--accent-soft:rgba(37,99,235,0.10);--accent-strong:#1d4ed8;
      --ok:#16a34a;--ok-soft:rgba(22,163,74,0.12);
      --danger:#ef4444;--danger-soft:rgba(248,113,113,0.12);
      --warn:#f59e0b;--warn-soft:rgba(245,158,11,0.16);
      --border-subtle:rgba(148,163,184,0.42);--border-strong:rgba(148,163,184,0.82);
      --radius-xl:22px;--radius-lg:18px;--radius-md:14px;--radius-pill:999px;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      background:
        radial-gradient(circle at top left,#e0edff 0,transparent 55%),
        radial-gradient(circle at top right,#fde2ff 0,transparent 55%),
        linear-gradient(180deg,#f9fafb,#eef2ff);
      min-height:100vh;display:flex;justify-content:center;align-items:flex-start;
      padding:14px;color:var(--text-main);
    }

    /* ✅ LOCKOUT 배경(빨간 그라데이션 깜빡임) */
    .page-wrap{
      width:100%;max-width:1240px;display:flex;flex-direction:column;gap:12px;position:relative;z-index:1;

      /* ✅ 스플래시 끝나기 전까지 숨김 */
      opacity:0;
      transform:translateY(6px);
      pointer-events:none;
      transition:opacity .22s ease, transform .22s ease;
    }
    .page-wrap.ready{
      opacity:1;
      transform:none;
      pointer-events:auto;
    }

    .lockout-bg{
      position:fixed;inset:0;z-index:0;pointer-events:none;
      opacity:0;transition:opacity .18s ease;
      background:
        radial-gradient(circle at 18% 22%, rgba(239,68,68,.55), transparent 60%),
        radial-gradient(circle at 82% 18%, rgba(249,115,22,.42), transparent 60%),
        radial-gradient(circle at 50% 90%, rgba(220,38,38,.22), transparent 60%),
        linear-gradient(180deg, rgba(127,29,29,.35), rgba(15,23,42,.12));
    }
    .lockout-bg.active{
      opacity:1;
      animation:lockoutPulse 1.05s ease-in-out infinite;
    }
    @keyframes lockoutPulse{
      0%{transform:scale(1);opacity:.18;filter:saturate(1.0)}
      50%{transform:scale(1.02);opacity:.62;filter:saturate(1.35)}
      100%{transform:scale(1);opacity:.18;filter:saturate(1.0)}
    }

    /* =========================
       ✅ SPLASH (Intro + Preload)
       ========================= */
    #splash{
      position:fixed; inset:0; z-index:9999;
      background:#ffffff; /* “아무것도 없는 바탕” */
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:14px;
      transition:opacity .28s ease, transform .28s ease;
    }
    #splash.hide{
      opacity:0;
      pointer-events:none;
      transform:scale(1.01);
    }
    #splashLogo{
      width:min(60px, 17vw);
      height:auto;
      display:block;
      filter:drop-shadow(0 10px 22px rgba(15,23,42,0.12));
    }
    #splashLoading{
      font-size:12px;
      color:#64748b;
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:0;
      transform:translateY(4px);
      transition:opacity .24s ease, transform .24s ease;
      user-select:none;
    }
    #splashLoading.show{
      opacity:1;
      transform:translateY(0);
    }
    #splashDots{
      display:inline-block;
      width:18px;
      text-align:left;
    }

    .top-bar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .top-left{display:flex;align-items:center;gap:12px}
    .logo-img{height:35px;width:auto;display:block;filter:drop-shadow(0 2px 6px rgba(15,23,42,0.18))}
    .title-block{display:flex;flex-direction:column;gap:2px}
    .title-main{font-size:18px;font-weight:600;letter-spacing:.03em}
    .title-sub{font-size:12px;color:var(--text-soft)}
    .top-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:var(--radius-pill);
      background:rgba(255,255,255,0.9);border:1px solid var(--border-subtle);
      backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
      font-size:11px;color:var(--text-soft)
    }
    .chip-label{font-weight:500}
    .chip-value{font-weight:600;color:var(--text-main)}
    .chip-dot{width:8px;height:8px;border-radius:999px;background:var(--danger);box-shadow:0 0 0 4px var(--danger-soft)}
    .chip-dot.ok{background:var(--ok);box-shadow:0 0 0 4px var(--ok-soft)}
    .shell{width:100%;display:flex;flex-direction:column;gap:12px}
    .card-base{
      position:relative;background:var(--card-bg);border-radius:var(--radius-xl);
      border:1px solid rgba(148,163,184,0.62);box-shadow:var(--card-shadow);
      padding:16px 18px;overflow:hidden;
      backdrop-filter:blur(20px) saturate(1.25);-webkit-backdrop-filter:blur(20px) saturate(1.25)
    }
    .card-base::before{
      content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
      background:linear-gradient(135deg,var(--card-glass-border-outer),var(--card-glass-border-inner));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;
      opacity:0.92;pointer-events:none
    }
    .card-base::after{
      content:"";position:absolute;inset:0;border-radius:inherit;
      background:radial-gradient(circle at 0 0,rgba(255,255,255,0.32),transparent 55%);
      opacity:0.6;pointer-events:none
    }
    .card-base>*{position:relative;z-index:1}
    .side-col{display:flex;flex-direction:column;gap:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .card-title{font-size:12px;font-weight:600;letter-spacing:.14em;text-transform:uppercase;color:var(--text-soft)}
    .card-badge{padding:3px 10px;border-radius:var(--radius-pill);background:var(--accent-soft);color:var(--accent-strong);font-size:11px;font-weight:500;white-space:nowrap}
    .section-label{margin-top:10px;font-size:11px;font-weight:600;letter-spacing:.10em;text-transform:uppercase;color:#9ca3af}
    .status-row{display:flex;flex-direction:column;gap:6px}
    .status-line{display:flex;align-items:baseline;justify-content:space-between;gap:10px}
    #statusText{font-size:clamp(18px,2.4vw,20px);font-weight:600;color:var(--text-main)}
    #statusPill{padding:4px 10px;border-radius:var(--radius-pill);font-size:11px;font-weight:600;letter-spacing:.12em;text-transform:uppercase}
    .status-ready{background:var(--ok-soft);color:var(--ok);box-shadow:0 0 0 1px rgba(22,163,74,0.5)}
    .status-count{background:var(--warn-soft);color:var(--warn);box-shadow:0 0 0 1px rgba(245,158,11,0.5)}
    .status-fire{background:rgba(248,113,113,0.14);color:#b91c1c;box-shadow:0 0 0 1px rgba(239,68,68,0.6)}
    .status-abort{background:rgba(254,202,202,0.9);color:#b91c1c;box-shadow:0 0 0 1px rgba(239,68,68,0.6)}
    .status-disc{background:#e5e7eb;color:#4b5563;box-shadow:0 0 0 1px rgba(148,163,184,0.9)}
    .status-lock{background:rgba(239,68,68,0.14);color:#991b1b;box-shadow:0 0 0 1px rgba(239,68,68,0.65)}
    .countdown-wrap{margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .countdown-label-block{display:flex;flex-direction:column;gap:2px}
    .countdown-caption{font-size:11px;color:var(--text-soft);letter-spacing:.14em;text-transform:uppercase}
    .countdown-sub{font-size:12px;color:var(--text-soft)}
    #countdown{
      font-family:SFMono-Regular,ui-monospace,Menlo,Monaco,Consolas,"Courier New",monospace;
      font-size:clamp(46px,7vw,64px);font-weight:800;letter-spacing:.05em;color:var(--danger);
      text-align:right;min-width:120px
    }
    #countdown span{font-size:14px;margin-left:4px;color:var(--text-soft);letter-spacing:0}
    .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .pill{
      padding:5px 12px;border-radius:var(--radius-pill);font-size:11px;
      border:1px solid rgba(148,163,184,0.5);background:rgba(249,250,251,0.96);color:var(--text-soft);
      display:inline-flex;align-items:center;gap:4px;white-space:nowrap
    }
    .pill strong{color:var(--text-main);font-weight:600;margin-right:4px}
    .pill-sep{opacity:.55;margin:0 2px}
    .pill-green{background:rgba(22,163,74,0.12);color:var(--ok);border-color:rgba(22,163,74,0.4)}
    .pill-red{background:rgba(248,113,113,0.12);color:var(--danger);border-color:rgba(248,113,113,0.4)}
    .pill-gray{background:#e5e7eb;color:#374151;border-color:rgba(148,163,184,0.7)}
    .ign-metrics{margin-top:6px;font-size:11px;color:var(--text-soft);display:flex;gap:10px}
    .ign-metrics span{white-space:nowrap}
    .item-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
    .item{
      display:flex;justify-content:space-between;align-items:center;
      padding:9px 10px;border-radius:var(--radius-md);
      background:linear-gradient(135deg,#f9fafb,#eef2ff);
      border:1px solid rgba(209,213,219,0.9)
    }
    .label{
      font-size:12px;color:#475569;font-weight:600;letter-spacing:.01em;
      display:flex;align-items:center;gap:8px;
    }
    .label-icon{
      width:6px;height:6px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 4px var(--accent-soft);
      animation:pulse-dot 3s ease-in-out infinite;
    }
    .value{
      display:flex;justify-content:flex-end;align-items:baseline;gap:7px;
      font-size:0;font-weight:600;color:var(--text-main);
    }
    .value .num{font-size:clamp(17px,2.2vw,21px);font-weight:650;letter-spacing:.01em;}
    .value .unit{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#64748b;}
    .item-pressure .value-block{display:flex;flex-direction:column;align-items:flex-end;gap:12px}
    .switch{position:relative;display:inline-block;width:52px;height:30px;}
    .switch input{display:none}
    .slider{
      position:absolute;inset:0;cursor:pointer;background:#e5e7eb;border-radius:999px;
      border:1px solid rgba(148,163,184,0.9);transition:.26s
    }
    .slider:before{
      position:absolute;content:'';height:24px;width:24px;left:3px;bottom:2px;background:#ffffff;border-radius:50%;
      box-shadow:0 4px 10px rgba(148,163,184,0.9);transition:.26s
    }
    input:checked+.slider{
      background:linear-gradient(90deg,#22c55e,#4ade80);
      box-shadow: inset 0 0 0 3px rgba(34,197,94,0.32);
    }
    input:checked+.slider:before{transform:translateX(20px)}
    button{
      border:none;border-radius:var(--radius-pill);font-family:inherit;cursor:pointer;
      transition:transform .12s ease,box-shadow .12s ease,background .12s ease,color .12s ease,border-color .12s ease;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    button:disabled{opacity:.45;box-shadow:none;cursor:default;transform:none}
    button:hover:not(:disabled){transform:translateY(-1px)}
    button:active:not(:disabled){transform:translateY(0);box-shadow:none}
    .controls-card button,.log-card button,.settings-dialog button,.launcher-dialog button{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;font-size:12px;font-weight:500
    }
    .toolbar-btn{
      border-radius:var(--radius-pill);border:1px solid rgba(148,163,184,0.6);
      background:linear-gradient(135deg,#f9fafb,#e5e7eb);color:#4b5563;
      padding:6px 10px;height:34px;box-shadow:0 8px 18px rgba(148,163,184,0.35);white-space:nowrap
    }
    .primary-btn{
      border-radius:var(--radius-pill);
      border:1px solid rgba(249,115,22,0.65);
      background:linear-gradient(120deg,rgba(244,67,54,0.78),rgba(249,115,22,0.78));
      color:#fff7ed;
      font-size:14px;font-weight:700;letter-spacing:.05em;
      padding:10px 18px;height:42px;width:100%;
      box-shadow:0 10px 26px rgba(249,115,22,0.32),0 6px 14px rgba(239,68,68,0.24);
      text-shadow:0 1px 2px rgba(0,0,0,0.12);
      backdrop-filter:blur(10px) saturate(1.15);-webkit-backdrop-filter:blur(10px) saturate(1.15);
    }
    .secondary-btn{
      border-radius:var(--radius-pill);
      border:1px solid rgba(148,163,184,0.55);
      background:linear-gradient(135deg,rgba(34, 36, 40, 0.78),rgba(64, 71, 84, 0.78));
      color:#f8fafc;
      font-size:12px;font-weight:700;letter-spacing:.04em;
      padding:10px 16px;height:42px;width:100%;
      box-shadow:0 8px 20px rgba(107,114,128,0.28);
      text-shadow:0 1px 2px rgba(0,0,0,0.12);
      backdrop-filter:blur(10px) saturate(1.05);-webkit-backdrop-filter:blur(10px) saturate(1.05);
    }
    .force-btn,.launcher-open-btn{
      margin-top:6px;width:100%;padding:10px 14px;border-radius:var(--radius-pill);
      border:1px solid rgba(148,163,184,0.75);background:linear-gradient(135deg,#f9fafb,#e5e7eb);
      color:#111827;font-size:13px;font-weight:600;box-shadow:0 8px 18px rgba(148,163,184,0.35)
    }
    .force-btn{justify-content:center}
    .force-btn.disabled{opacity:.45;pointer-events:none;filter:saturate(0.6) grayscale(0.1)}
    .launcher-open-btn{justify-content:space-between}
    .controls-card{padding-top:14px;padding-bottom:14px}
    .controls-subtitle{font-size:11px;color:var(--text-soft);margin-top:2px}
    .controls-help{font-size:11px;color:var(--accent-strong);margin-top:4px;cursor:pointer;text-decoration:underline}
    .controls-grid{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .controls-section-label{margin-top:6px;font-size:11px;font-weight:600;letter-spacing:.10em;text-transform:uppercase;color:#9ca3af}
    .controls-toolbar{margin-top:4px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
    .controls-main-row{display:flex;gap:8px;align-items:stretch;margin-top:4px}
    .primary-btn-wrap{flex:3;display:flex}
    .abort-btn-wrap{flex:1.4;display:flex}
    .control-row{display:flex;flex-wrap:wrap;gap:8px;align-items:stretch;margin-top:6px}
    .control-tile{
      padding:10px 12px;border-radius:var(--radius-md);
      border:1px solid rgba(209,213,219,0.9);background:linear-gradient(135deg,#f9fafb,#eef2ff);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex:1 1 0
    }
    .control-tile-label{font-size:13px;color:#111827;font-weight:500}
    .control-tile-sub{font-size:11px;color:#6b7280;margin-top:2px}
    .controls-header-actions{display:flex;align-items:center;gap:6px}
    .controls-gear-btn{
      width:26px;height:26px;border-radius:999px;border:1px solid rgba(148,163,184,0.75);
      background:radial-gradient(circle at 30% 20%,#f9fafb,#e5e7eb);
      color:#4b5563;font-size:14px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 8px 18px rgba(148,163,184,0.4);padding:0
    }
    .controls-gear-btn:hover{background:#0f172a;color:#e5e7eb}
    .charts-card{padding:14px}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap}
    .chart-title-main{font-size:12px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--text-soft)}
    .chart-controls{display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end}
    .chart-btn{
      border-radius:var(--radius-pill);border:1px solid rgba(148,163,184,0.7);
      background:#f9fafb;color:#4b5563;padding:2px 8px;font-size:11px;min-width:26px;text-align:center
    }
    .chart-btn-live{background:var(--accent);border-color:var(--accent-strong);color:#eff6ff;font-weight:600;letter-spacing:.05em}
    .chart-row{display:flex;flex-direction:row;flex-wrap:wrap;gap:10px;margin-top:4px}
    .chart-box{
      background:linear-gradient(135deg,#eef2ff,#e5e7eb);
      border-radius:var(--radius-md);padding:6px;border:1px solid rgba(148,163,184,0.7);flex:1 1 260px
    }
    .chart-box-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .chart-title{font-size:12px;font-weight:600;color:#111827}
    .chart-badge{font-size:10px;padding:3px 8px;border-radius:var(--radius-pill);background:rgba(255,255,255,0.8);color:#4b5563}
    .chart-box canvas{width:100%;display:block}
    .chart-box canvas{ height:220px; }
    @media(min-width:768px){ .chart-box canvas{ height:240px; } }
    @media(min-width:1100px){ .chart-box canvas{ height:260px; } }

    .log-card{
      position:relative;background:#020617;color:#e5e7eb;border-radius:20px;
      padding:10px;box-shadow:0 18px 50px rgba(15,23,42,0.85);
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
      font-size:11px;display:flex;flex-direction:column;height:260px;max-height:260px;
      border:1px solid rgba(15,23,42,0.95);backdrop-filter:blur(18px) saturate(1.2);-webkit-backdrop-filter:blur(18px) saturate(1.2);
      overflow:hidden
    }
    @media(min-width:1024px){.log-card{height:300px;max-height:300px}}
    .log-card::before{
      content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
      background:linear-gradient(135deg,rgba(148,163,184,0.8),rgba(37,99,235,0.9),rgba(15,23,42,1));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;opacity:0.8;pointer-events:none
    }
    .log-card::after{
      content:"";position:absolute;inset:0;border-radius:inherit;
      background:radial-gradient(circle at 0 0,rgba(248,250,252,0.12),transparent 55%);
      opacity:0.8;pointer-events:none
    }
    .log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px}
    .log-title{font-size:11px;font-weight:600;letter-spacing:.14em;text-transform:uppercase;color:#9ca3af}
    .terminal-shell{
      margin-top:4px;border-radius:14px;border:1px solid #020617;background:#020617;
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
      flex:1 1 auto;min-height:0;display:flex;flex-direction:column;overflow:hidden
    }
    .terminal-header{display:flex;align-items:center;justify-content:space-between;padding:6px 9px;background:#020617;border-bottom:1px solid #111827}
    .term-title{font-size:10px;color:#9ca3af}
    #logView{
      padding:8px 10px;flex:1 1 auto;min-height:0;overflow-y:auto;overflow-x:hidden;
      white-space:pre-wrap;word-wrap:break-word;scrollbar-width:thin;scrollbar-color:#4b5563 #020617
    }
    #logView::-webkit-scrollbar{width:6px}
    #logView::-webkit-scrollbar-track{background:#020617}
    #logView::-webkit-scrollbar-thumb{background:#4b5563;border-radius:999px}
    .log-line{font-family:inherit;font-size:11px;line-height:1.4;color:#e5e7eb}
    .log-prefix{color:#6b7280}

    .toast-container{position:fixed;top:18px;right:18px;z-index:80;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .toast{
      position:relative;width:min(420px,calc(100vw - 36px));padding:12px 14px;border-radius:18px;
      background:rgba(255,255,255,0.62);
      border:1px solid var(--toast-border, rgba(148,163,184,0.55));
      backdrop-filter:blur(24px) saturate(1.25);-webkit-backdrop-filter:blur(24px) saturate(1.25);
      box-shadow:0 18px 40px rgba(15,23,42,0.18);
      overflow:hidden;display:flex;align-items:center;gap:12px;
      opacity:0;transform:translateX(14px);pointer-events:auto;
    }
    .toast::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at 20% 0,rgba(255,255,255,0.26),transparent 55%);pointer-events:none}
    .toast-show{animation:toastIn .24s ease-out forwards}
    .toast-hide{animation:toastOut .18s ease-in forwards}
    @keyframes toastIn{to{opacity:1;transform:translateX(0)}}
    @keyframes toastOut{to{opacity:0;transform:translateX(14px)}}
    .toast-icon{
      width:44px;height:44px;border-radius:999px;flex-shrink:0;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at 30% 20%,rgba(255,255,255,0.95),rgba(255,255,255,0.55));
      border:1px solid rgba(255,255,255,0.70);
      box-shadow:0 10px 22px rgba(15,23,42,0.18),0 0 0 6px var(--toast-ring, rgba(148,163,184,0.16));
    }
    .toast-icon img{width:22px;height:22px;display:block;filter:drop-shadow(0 2px 6px rgba(15,23,42,0.18))}
    .toast-body{flex:1;min-width:0}
    .toast-title{font-size:13px;font-weight:800;letter-spacing:.02em;color:#0f172a}
    .toast-text{margin-top:3px;font-size:12px;color:#475569;line-height:1.45;word-break:keep-all}
    .toast-info{--toast-border:rgba(96,165,250,0.40);--toast-ring:rgba(96,165,250,0.16)}
    .toast-success{--toast-border:rgba(52,211,153,0.40);--toast-ring:rgba(52,211,153,0.16)}
    .toast-warn{--toast-border:rgba(251,191,36,0.45);--toast-ring:rgba(251,191,36,0.18)}
    .toast-error{--toast-border:rgba(251,113,133,0.45);--toast-ring:rgba(251,113,133,0.18)}
    .toast-ignite{--toast-border:rgba(249,115,22,0.45);--toast-ring:rgba(249,115,22,0.18)}
    @media(max-width:600px){.toast-container{top:14px;right:12px}}

    .confirm-overlay,.settings-overlay{
      position:fixed;inset:0;background:rgba(15,23,42,0.45);
      display:flex;align-items:center;justify-content:center;padding:16px;z-index:50
    }
    .hidden{display:none}
    .confirm-dialog{
      position:relative;background:#020617;border-radius:20px;padding:18px 18px 14px;width:100%;max-width:360px;
      box-shadow:0 22px 55px rgba(15,23,42,0.95);color:#e5e7eb;border:1px solid rgba(59,130,246,0.85);
      backdrop-filter:blur(20px) saturate(1.3);-webkit-backdrop-filter:blur(20px) saturate(1.3);overflow:hidden
    }
    .confirm-dialog::before{
      content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
      background:linear-gradient(145deg,rgba(248,250,252,0.95),rgba(59,130,246,0.9),rgba(15,23,42,1));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;opacity:0.9;pointer-events:none
    }
    .confirm-dialog::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle at 20% 0,rgba(251,191,36,0.22),transparent 60%);opacity:0.9;pointer-events:none}
    .confirm-icon{
      width:44px;height:44px;border-radius:999px;background:radial-gradient(circle at 30% 20%,#fff7ed,#fed7aa);
      display:flex;align-items:center;justify-content:center;margin:2px auto 10px;box-shadow:0 10px 25px rgba(248,148,77,0.6)
    }
    .confirm-icon img{width:24px;height:24px;display:block;filter:drop-shadow(0 2px 6px rgba(15,23,42,0.35))}
    .confirm-title{font-size:15px;font-weight:600;text-align:center;margin-bottom:4px}
    .confirm-text{font-size:12px;color:#9ca3af;margin-bottom:10px;line-height:1.5;text-align:center}
    .confirm-note{font-size:11px;color:#64748b;text-align:center;margin-bottom:10px}
    .confirm-actions{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:4px}
    .confirm-cancel{border:none;background:none;color:#9ca3af;font-size:11px;text-decoration:underline;cursor:pointer;margin-top:2px;box-shadow:none}
    .confirm-cancel:hover{color:#e5e7eb}
    .longpress-wrap{display:flex;justify-content:center;width:100%;margin-bottom:2px}
    .longpress-btn{
      position:relative;width:86px;height:86px;border-radius:999px;border:none;
      background:radial-gradient(circle at 30% 20%,#111827,#020617);
      color:#e5e7eb;font-size:11px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(51,65,85,0.9),0 18px 34px rgba(15,23,42,0.95);overflow:hidden
    }
    .longpress-btn::before{content:'';position:absolute;inset:16px;border-radius:999px;background:radial-gradient(circle at 30% 20%,#111827,#020617);opacity:.95}
    .longpress-btn span{position:relative;text-align:center;line-height:1.2;pointer-events:none;z-index:1;font-weight:500;letter-spacing:.06em}
    .longpress-ring{position:absolute;inset:5px;border-radius:999px;overflow:hidden;pointer-events:none}
    .longpress-spinner{
      position:absolute;inset:0;border-radius:999px;
      background:conic-gradient(#38bdf8 var(--lp-angle,0deg),rgba(15,23,42,0.18) var(--lp-angle,0deg) 360deg);
      -webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 4px),#000 100%);
      mask:radial-gradient(farthest-side,transparent calc(100% - 4px),#000 100%);
      box-shadow:0 0 16px rgba(56,189,248,0.6)
    }
    .force-actions{width:100%;display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .force-cancel-big{
      width:100%;height:40px;border-radius:var(--radius-pill);
      border:1px solid rgba(148,163,184,0.75);
      background:linear-gradient(135deg,#f9fafb,#e5e7eb);
      color:#111827;font-size:14px;font-weight:800;
      box-shadow:0 10px 24px rgba(15,23,42,0.65);
    }
    .force-danger-small{
      width:100%;height:40px;border-radius:var(--radius-pill);
      border:1px solid rgba(239,68,68,0.9);
      background:linear-gradient(135deg,#ef4444,#f97316);
      color:#fff7ed;font-size:12px;font-weight:800;letter-spacing:.04em;
      box-shadow:0 10px 22px rgba(239,68,68,0.55);
    }

    .launcher-dialog{
      position:relative;background:#020617;border-radius:20px;padding:16px 18px 14px;width:100%;max-width:340px;
      box-shadow:0 22px 55px rgba(15,23,42,0.95);border:1px solid rgba(59,130,246,0.8);color:#e5e7eb;
      backdrop-filter:blur(18px) saturate(1.25);-webkit-backdrop-filter:blur(18px) saturate(1.25);
      overflow:hidden
    }
    .launcher-dialog::before{
      content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
      background:linear-gradient(145deg,rgba(248,250,252,0.9),rgba(129,140,248,0.9),rgba(15,23,42,1));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;opacity:0.85;pointer-events:none
    }
    .launcher-dialog::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle at 15% 0,rgba(191,219,254,0.25),transparent 60%);opacity:0.9;pointer-events:none}
    .launcher-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .launcher-title{font-size:13px;font-weight:600;letter-spacing:.10em;text-transform:uppercase;color:#9ca3af}
    .launcher-close-btn{border:none;background:transparent;font-size:18px;line-height:1;padding:2px 4px;border-radius:999px;box-shadow:none;color:#9ca3af}
    .launcher-close-btn:hover{background:rgba(15,23,42,0.6);color:#e5e7eb}
    .launcher-note{font-size:11px;color:#9ca3af;margin-bottom:10px}
    .launcher-controls{margin-top:4px;display:flex;flex-direction:column;gap:10px}
    .launcher-arrow-row{display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:10px 0}
    .launcher-arrow-btn{
      width:92px;height:46px;border-radius:999px;border:none;
      background:linear-gradient(135deg,#e5e7eb,#9ca3af);
      color:#111827;font-size:18px;font-weight:800;
      box-shadow:0 10px 24px rgba(15,23,42,0.7);
      user-select:none;touch-action:none
    }
    .launcher-arrow-btn.pressed{background:#4b5563;color:#f9fafb}
    .launcher-hint{font-size:10px;color:#9ca3af;text-align:center;margin-top:2px}
    .controls-hint{font-size:11px;color:#6b7280;margin-top:2px}
    .control-tile.disabled{opacity:.55;pointer-events:none;filter:grayscale(0.1)}

    .inspection-dialog{
      position:relative;width:520px;max-width:95vw;
      background:rgba(255,255,255,0.97);border-radius:18px;
      box-shadow:0 22px 55px rgba(15,23,42,0.18);
      border:1px solid rgba(148,163,184,0.7);
      padding:14px 16px 12px;
      color:var(--text-main);
      backdrop-filter:blur(20px) saturate(1.1);-webkit-backdrop-filter:blur(20px) saturate(1.1);
    }
    .inspection-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .inspection-title{font-size:13px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#0f172a}
    .inspection-sub{font-size:11px;color:#6b7280;margin-top:2px}
    .inspection-close-btn{border:none;background:transparent;font-size:18px;line-height:1;padding:2px 4px;border-radius:999px;box-shadow:none;color:#9ca3af}
    .inspection-close-btn:hover{background:rgba(229,231,235,0.7);color:#111827}
    .inspection-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .inspection-item{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(209,213,219,0.9);
      background:linear-gradient(135deg,#f9fafb,#eef2ff);
    }
    .inspection-left{display:flex;align-items:center;gap:10px}
    .inspection-dot{width:10px;height:10px;border-radius:999px;background:#cbd5e1;box-shadow:0 0 0 5px rgba(203,213,225,0.28)}
    .inspection-label{font-size:13px;font-weight:600;color:#0f172a}
    .inspection-desc{font-size:11px;color:#6b7280}
    .inspection-status{font-size:12px;color:#4b5563;font-weight:600;white-space:nowrap}
    .inspection-item.state-running .inspection-dot{background:#f59e0b;box-shadow:0 0 0 5px rgba(245,158,11,0.22)}
    .inspection-item.state-ok .inspection-dot{background:var(--ok);box-shadow:0 0 0 5px var(--ok-soft)}
    .inspection-item.state-bad .inspection-dot{background:var(--danger);box-shadow:0 0 0 5px var(--danger-soft)}
    .inspection-item.state-running .inspection-status{color:#f59e0b}
    .inspection-item.state-ok .inspection-status{color:#166534}
    .inspection-item.state-bad .inspection-status{color:#b91c1c}
    .inspection-footer{margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .inspection-result{font-size:12px;font-weight:600;color:#475569}
    .inspection-result.ok{color:#166534}
    .inspection-result.error{color:#b91c1c}
    .inspection-result.running{color:#f59e0b}
    .inspection-actions{display:flex;gap:8px}

    .settings-dialog{
      position:relative;width:640px;max-width:95vw;height:460px;max-height:90vh;
      background:rgba(255,255,255,0.97);border-radius:20px;box-shadow:0 22px 55px rgba(15,23,42,0.18);
      padding:14px 18px 12px;color:var(--text-main);
      border:1px solid rgba(148,163,184,0.7);
      display:flex;flex-direction:column;
      backdrop-filter:blur(22px) saturate(1.2);-webkit-backdrop-filter:blur(22px) saturate(1.2);
      overflow:hidden
    }
    .settings-dialog::before{
      content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
      background:linear-gradient(145deg,rgba(255,255,255,0.98),rgba(148,163,184,0.8));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;opacity:0.85;pointer-events:none
    }
    .settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-shrink:0}
    .settings-title{font-size:13px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--text-soft)}
    .settings-close-btn{border:none;background:transparent;font-size:18px;line-height:1;padding:2px 4px;border-radius:999px;box-shadow:none;color:#9ca3af}
    .settings-close-btn:hover{background:rgba(229,231,235,0.7);color:#111827}
    .settings-body{margin-top:4px;display:flex;gap:12px;flex:1;overflow-y:auto;min-height:0}
    .settings-nav{width:160px;border-right:1px solid rgba(209,213,219,0.9);padding-right:8px;display:flex;flex-direction:column;gap:4px;flex-shrink:0}
    .settings-nav-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.10em;color:#9ca3af;margin-bottom:4px}

    /* ✅ 설정 네비/버튼 살짝 업그레이드 */
    .settings-nav-btn{
      border:none;background:transparent;padding:6px 8px;border-radius:12px;font-size:12px;text-align:left;color:#6b7280;
      display:flex;justify-content:space-between;align-items:center;box-shadow:none;
      border:1px solid transparent;position:relative;padding-left:26px;
      transition:background .12s ease,border-color .12s ease,color .12s ease;
    }
    .settings-nav-btn::before{
      content:"";position:absolute;left:10px;top:50%;
      width:7px;height:7px;border-radius:999px;transform:translateY(-50%);
      background:rgba(148,163,184,0.9);box-shadow:0 0 0 4px rgba(148,163,184,0.14);opacity:.55;
    }
    .settings-nav-btn span{font-weight:500}
    .settings-nav-badge{font-size:10px;color:#9ca3af}
    .settings-nav-btn:hover{background:#f3f4f6}
    .settings-nav-btn.active{
      background:linear-gradient(135deg,#0f172a,#111827);
      border-color:rgba(148,163,184,0.28);
      color:#e5e7eb;
    }
    .settings-nav-btn.active .settings-nav-badge{color:#e5e7eb;opacity:.7}
    .settings-nav-btn.active::before{
      background:#38bdf8;box-shadow:0 0 0 5px rgba(56,189,248,0.22);opacity:1;
    }

    .settings-panels{flex:1;padding-left:4px;min-width:0}
    .settings-panel{display:none;animation:fadeInSettings .15s ease-out}
    .settings-panel.active{display:block}
    .settings-group{padding:6px 0 10px;border-top:1px solid rgba(229,231,235,0.9)}
    .settings-group:first-of-type{border-top:none}
    .settings-group-title{font-size:12px;font-weight:600;letter-spacing:.10em;text-transform:uppercase;color:#9ca3af;margin-bottom:6px}
    .settings-row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:6px 0}
    .settings-label{font-size:13px;color:#111827;font-weight:600}
    .settings-desc{font-size:11px;color:#6b7280;text-align:right;line-height:1.35}
    .settings-select{min-width:110px;padding:4px 8px;font-size:12px;border-radius:999px;border:1px solid rgba(148,163,184,0.9);background:#f9fafb}
    .settings-number-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
    .settings-number{width:90px;padding:6px 8px;font-size:13px;border-radius:999px;border:1px solid rgba(148,163,184,0.9);background:#f9fafb;text-align:center;outline:none}
    .settings-number:focus{box-shadow:0 0 0 2px rgba(59,130,246,0.35);border-color:rgba(59,130,246,0.9)}
    .settings-footer{margin-top:8px;display:flex;justify-content:flex-end;flex-shrink:0}
    .settings-save-btn{padding:8px 16px;font-size:13px;border-radius:999px;border:none;background:#0f172a;color:#e5e7eb;box-shadow:0 8px 18px rgba(15,23,42,0.4)}
    .footer-nav{margin-top:6px;display:flex;justify-content:center}
    .footer-meta{font-size:11px;color:#9ca3af}
    .hint-mini{margin-top:3px;font-size:11px;color:#64748b;line-height:1.35}
    .hint-mini strong{color:#0f172a}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
    .serial-pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid rgba(148,163,184,0.55);background:rgba(249,250,251,0.96);font-size:11px;color:#64748b}
    .serial-pill.ok{border-color:rgba(22,163,74,0.45);background:rgba(22,163,74,0.10);color:#166534}
    .serial-pill.bad{border-color:rgba(239,68,68,0.45);background:rgba(239,68,68,0.10);color:#991b1b}
    .serial-pill .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8;box-shadow:0 0 0 4px rgba(148,163,184,0.18)}
    .serial-pill.ok .dot{background:var(--ok);box-shadow:0 0 0 4px var(--ok-soft)}
    .serial-pill.bad .dot{background:var(--danger);box-shadow:0 0 0 4px var(--danger-soft)}

    button:focus-visible,input:focus-visible,select:focus-visible{
      outline:none;
      box-shadow:0 0 0 3px rgba(59,130,246,0.35);
    }

    @keyframes pulse-dot{
      0%{transform:scale(1);box-shadow:0 0 0 3px rgba(37,99,235,0.18)}
      50%{transform:scale(1.05);box-shadow:0 0 0 5px rgba(37,99,235,0.26)}
      100%{transform:scale(1);box-shadow:0 0 0 3px rgba(37,99,235,0.18)}
    }
    @keyframes fadeInSettings{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:translateY(0)}}
    #launcherOverlay{align-items:center;justify-content:center}
    #inspectionOverlay{align-items:center;justify-content:center}
    @media(max-width:600px){#launcherOverlay{align-items:center!important;justify-content:center!important;padding:16px!important}}
    @media(max-width:600px){#inspectionOverlay{align-items:center!important;justify-content:center!important;padding:0 12px!important}}
    @media(max-width:767px){
      .shell{display:flex;flex-direction:column;gap:10px}
      .side-col{display:contents}
      .main-card{order:1}
      .controls-card{order:2}
      .charts-card{order:3}
      .log-card{order:4}
    }
    @media(min-width:768px){
      .shell{display:grid;grid-template-columns:minmax(0,2.8fr) minmax(320px,1fr);grid-template-areas:"main side" "charts side";gap:14px}
      .main-card{grid-area:main}
      .charts-card{grid-area:charts;min-height:220px}
      .side-col{grid-area:side}
      .item-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media(min-width:1100px){.shell{grid-template-columns:minmax(0,2.8fr) minmax(340px,1fr)}}
    @media(max-width:600px){
      body{padding:10px}
      .top-bar{flex-direction:column;align-items:stretch;gap:8px}
      .top-right{justify-content:flex-start}
      .logo-img{height:40px}
      .title-main{font-size:16px}
      .title-sub{font-size:11px}
      .card-base{padding:14px 14px}
      .countdown-wrap{display:grid;grid-template-columns:1fr auto;align-items:end;gap:10px}
      .countdown-label-block{min-width:0}
      #countdown{justify-self:end;min-width:0;line-height:1;font-size:clamp(34px,11vw,48px)}
      .item-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
      .controls-main-row{flex-direction:column}
      .primary-btn,.secondary-btn{height:44px}
      .chart-row{flex-direction:column}
      .chart-box{flex:1 1 auto}
      .settings-overlay{align-items:flex-end;justify-content:center;padding:0}
      .settings-dialog{
        width:100%;max-width:100%;height:auto;max-height:82vh;border-radius:18px 18px 0 0;margin:0;
        padding:14px 16px max(12px,env(safe-area-inset-bottom,12px))
      }
      .settings-body{flex-direction:column;overflow-y:auto;padding-right:2px}
      .settings-nav{
        width:100%;border-right:none;border-bottom:1px solid rgba(209,213,219,0.9);
        padding-right:0;padding-bottom:6px;flex-direction:row;gap:6px;overflow-x:auto
      }
      .settings-nav-btn{flex:1;justify-content:center;padding-left:10px}
      .settings-nav-btn::before{display:none}
      .launcher-arrow-btn{width:110px;height:54px;font-size:20px}
    }
    @media(max-width:380px){
      .countdown-wrap{grid-template-columns:1fr}
      #countdown{margin-top:6px;justify-self:end}
      .item-grid{grid-template-columns:1fr}
    }

    /* ✅ LOCKOUT 모달 */
    .lockout-dialog{max-width:420px;border:1px solid rgba(239,68,68,0.9);}
    .lockout-dialog::after{background:radial-gradient(circle at 20% 0,rgba(239,68,68,0.22),transparent 60%);}
    .lockout-close{position:absolute;right:10px;top:10px;color:#cbd5e1;}
    .lockout-close:hover{background:rgba(15,23,42,0.55);color:#fff;}
    .lockout-figure{
      width:100%;border-radius:16px;overflow:hidden;
      border:1px solid rgba(148,163,184,0.25);
      background:rgba(2,6,23,0.55);
      margin:6px 0 12px;
      box-shadow:0 18px 40px rgba(15,23,42,0.65);
    }
    .lockout-img{display:block;width:100%;height:auto;}

    /* ✅ FW 섹션에 작은 F 로고 */
    .fw-head{
      display:flex;align-items:center;gap:10px;
      padding:6px 0 6px;
    }
    .fw-f-logo{
      width:22px;height:22px;object-fit:contain;
      filter:drop-shadow(0 2px 6px rgba(15,23,42,0.16));
      opacity:.95;
    }

    /* ✅ 접근성/JS 호환용 숨김 버튼 */
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }

    /* ✅ 타일을 "버튼"처럼 */
    .control-tile.is-btn{
      cursor:pointer;
      user-select:none;
      padding:10px 12px;        /* 세로 길이 줄임 */
      min-height:62px;          /* 기존 70px → 줄임 */
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }

    .control-tile.is-btn:hover{
      transform:translateY(-1px);
      border-color:rgba(37,99,235,0.55);
      box-shadow:0 10px 22px rgba(37,99,235,0.14);
    }

    .control-tile.is-btn:active{
      transform:translateY(0);
      box-shadow:0 6px 14px rgba(148,163,184,0.22);
    }

    .control-tile.is-btn:focus-visible{
      outline:none;
      box-shadow:0 0 0 3px rgba(59,130,246,0.35), 0 10px 22px rgba(37,99,235,0.14);
      border-color:rgba(59,130,246,0.9);
    }

    /* ✅ 오른쪽 액션 영역 정렬 고정(줄바꿈 방지) */
    .control-tile-actions{
      display:flex;
      align-items:center;
      flex-wrap:nowrap;
      gap:10px;
    }

    /* ✅ 서브텍스트 조금 타이트하게 */
    .control-tile-sub{
      line-height:1.25;
    }

    /* ✅ 위험 타일(강제 점화) 강조 */
    .control-tile.is-danger:hover{
      border-color:rgba(239,68,68,0.55);
      box-shadow:0 10px 22px rgba(239,68,68,0.18);
    }

  </style>
</head>
<body>
  <!-- ✅ LOCKOUT 배경 오버레이 -->
  <div id="lockoutBg" class="lockout-bg" aria-hidden="true"></div>

  <!-- ✅ SPLASH: 로고 먼저 → 2초 뒤 로딩중 → 이미지 프리로드 완료되면 진입 -->
  <div id="splash" aria-label="loading">
    <img id="splashLogo" src="img/Flash_logo.png" alt="FLASH">
    <div id="splashLoading">로딩중<span id="splashDots"></span></div>
  </div>

  <div class="page-wrap">
    <div id="toastContainer" class="toast-container"></div>

    <header class="top-bar">
      <div class="top-left">
        <img class="logo-img" src="img/Flash_logo.png" alt="ALTIS logo">
        <div class="title-block">
          <div class="title-main">FLASH6</div>
          <div class="title-sub">ALTIS DAQ SYSTEM</div>
        </div>
      </div>
      <div class="top-right">
        <div class="chip" id="conn-chip">
          <div class="chip-dot" id="conn-dot"></div>
          <div class="chip-label">STATUS</div>
          <div class="chip-value" id="conn-text">DISCONNECTED</div>
        </div>
        <div class="chip">
          <div class="chip-label">Wi-Fi</div>
          <div class="chip-value">192.168.4.1</div>
        </div>
        <div class="chip">
          <div class="chip-label">KST</div>
          <div class="chip-value" id="kst-time">--:--:--</div>
        </div>
      </div>
    </header>

    <main class="shell">
      <section class="card-base main-card">
        <div class="card-header">
          <div class="card-title">COUNTDOWN & STATUS</div>
          <div class="card-badge">LIVE SESSION</div>
        </div>

        <div class="status-row">
          <div class="status-line">
            <div id="statusText">System ready</div>
            <div id="statusPill" class="status-ready">READY</div>
          </div>
        </div>

        <div class="countdown-wrap">
          <div class="countdown-label-block">
            <div class="countdown-caption">T-MINUS</div>
            <div class="countdown-sub">Main ignition countdown</div>

          <div class="pill-row">
            <div class="pill">
              <strong>Snap</strong>
              <span id="loop-pill">-- ms</span>
              <span class="pill-sep">·</span>
              <span id="snap-hz">-- Hz</span>
            </div>

            <div class="pill">
              <strong>HX711</strong>
              <span id="hx-hz">-- Hz</span>
              <span class="pill-sep">·</span>
              <span id="cpu-us">-- us</span>
            </div>

            <div class="pill"><strong>Mode</strong> <span id="mode-pill">-</span></div>
            <div class="pill"><strong>Relay</strong> <span id="relay-safe-pill">SAFE</span></div>
          </div>
        </div>

        <div id="countdown">--<span>s</span></div>
      </div>

        <div class="section-label">Live Telemetry</div>
        <div class="ign-metrics">
          <span id="ignDelayDisplay">Delay --.-s</span>
          <span id="burnDurationDisplay">Burn --.-s</span>
        </div>

        <div class="item-grid">
          <div class="item">
            <span class="label"><span class="label-icon"></span>추력 (<span data-label="thrust-unit">kgf</span>)</span>
            <span id="thrust" class="value">--</span>
          </div>

          <div class="item item-pressure">
            <span class="label"><span class="label-icon"></span>압력 (V)</span>
            <div class="value-block"><span id="pressure" class="value">--</span></div>
          </div>

          <div class="item">
            <span class="label"><span class="label-icon"></span>스위치</span>
            <span id="sw" class="pill pill-gray">--</span>
          </div>

          <div class="item">
            <span class="label"><span class="label-icon"></span>Igniter</span>
            <span id="ic" class="pill pill-red">--</span>
          </div>

          <div class="item">
            <span class="label"><span class="label-icon"></span>릴레이</span>
            <span id="relay" class="pill pill-gray">--</span>
          </div>

          <div class="item">
            <span class="label"><span class="label-icon"></span>Loop Time</span>
            <span id="lt" class="value">-- ms</span>
          </div>
        </div>
      </section>

      <section class="card-base charts-card">
        <div class="chart-header">
          <div class="chart-title-main">THRUST & PRESSURE TREND</div>
          <div class="chart-controls">
            <button id="chartZoomOut" class="chart-btn">-</button>
            <button id="chartZoomIn" class="chart-btn">+</button>
            <button id="chartLeft" class="chart-btn">◀</button>
            <button id="chartRight" class="chart-btn">▶</button>
            <button id="chartLive" class="chart-btn chart-btn-live">LIVE</button>
          </div>
        </div>

        <div class="chart-row">
          <div class="chart-box">
            <div class="chart-box-header">
              <div class="chart-title">Thrust</div>
              <div class="chart-badge" data-badge="thrust-unit">RED · kgf</div>
            </div>
            <canvas id="thrustChart"></canvas>
          </div>

          <div class="chart-box">
            <div class="chart-box-header">
              <div class="chart-title">Pressure</div>
              <div class="chart-badge" data-badge="pressure-unit">BLUE · V</div>
            </div>
            <canvas id="pressureChart"></canvas>
          </div>
        </div>
      </section>

      <div class="side-col">
        <section class="log-card">
          <div class="log-header"><div class="log-title">EVENT LOG</div></div>
          <div class="terminal-shell">
            <div class="terminal-header"><div class="term-title">hanwool-tms@board: ~</div></div>
            <div id="logView"></div>
          </div>
        </section>

        <section class="card-base controls-card">
          <div class="card-header">
            <div>
              <div class="card-title">CONTROL PANEL</div>
              <div class="controls-subtitle">제어 · 데이터</div>
              <div id="controlsHelpLink" class="controls-help">도움말로 바로가기</div>
            </div>
            <div class="controls-header-actions">
              <button id="controlsSettingsBtn" class="controls-gear-btn" title="Settings">⚙</button>
            </div>
          </div>

          <div class="controls-grid">
            <div class="controls-section-label">데이터</div>
            <div class="controls-toolbar">
              <button id="copyLogBtn" class="toolbar-btn">Copy Log</button>
              <button id="exportCsvBtn" class="toolbar-btn">Export CSV</button>
            </div>

            <div class="controls-section-label">시퀀스 제어</div>
            <div class="controls-main-row">
              <div class="primary-btn-wrap"><button id="igniteBtn" class="primary-btn">Sequence Start</button></div>
              <div class="abort-btn-wrap"><button id="abortBtn" class="secondary-btn" disabled>ABORT</button></div>
            </div>

            <button id="forceIgniteBtn" class="force-btn">강제 점화</button>

            <div class="controls-section-label">컨트롤</div>
            <div class="control-row">
              <div class="control-tile">
                <div>
                  <div class="control-tile-label">WebSerial</div>
                  <div class="control-tile-sub">시리얼 연결</div>
                </div>
                <div class="control-tile-actions">
                  <label class="switch" title="WebSerial">
                    <input type="checkbox" id="serialToggle">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>

              <div id="inspectionOpenBtn" class="control-tile is-btn" role="button" tabindex="0">
                <div>
                  <div class="control-tile-label">설비 점검</div>
                </div>
                <div class="control-tile-actions">
                  <span id="inspectionStatusPill" class="pill pill-gray">대기</span>
                </div>
              </div>

              <div id="launcherOpenBtn" class="control-tile is-btn" role="button" tabindex="0">
                <div>
                  <div class="control-tile-label">발사대</div>
                  <div class="control-tile-sub">발사대 모터/액츄에이터제어</div>
                </div>
                <div class="control-tile-actions">
                  <span class="pill pill-gray">OPEN</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- 설정 -->
    <div id="settingsOverlay" class="settings-overlay hidden">
      <div class="settings-dialog">
        <div class="settings-header">
          <div class="settings-title">CONTROL SETTINGS</div>
          <button id="settingsClose" class="settings-close-btn">×</button>
        </div>

        <div class="settings-body">
          <nav class="settings-nav">
            <div class="settings-nav-title">섹션</div>
            <button class="settings-nav-btn active" data-target="connect"><span>연결</span><span class="settings-nav-badge">Connect</span></button>
            <button class="settings-nav-btn" data-target="units"><span>단위</span><span class="settings-nav-badge">Units</span></button>
            <button class="settings-nav-btn" data-target="sequence"><span>시퀀스</span><span class="settings-nav-badge">Sequence</span></button>
            <button class="settings-nav-btn" data-target="safety"><span>SAFETY</span><span class="settings-nav-badge">Safety</span></button>
            <button class="settings-nav-btn" data-target="fw"><span>펌웨어</span><span class="settings-nav-badge">Firmware</span></button>
          </nav>

          <div class="settings-panels">
            <!-- CONNECT -->
            <div class="settings-panel active" data-panel="connect">
              <div class="settings-group">
                <div class="settings-group-title">연결 모드</div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">디버깅용 시리얼(WebSerial)</div>
                    <div class="hint-mini">컨트롤 패널에서 바로 On/Off 합니다.</div>
                  </div>
                  <div class="settings-desc mono">Control Panel</div>
                </div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">시리얼 연결 상태</div>
                    <div class="hint-mini">연결되면 “CONNECTED”로 표시되고, /set /countdown_start 등이 시리얼로도 전송됩니다.</div>
                  </div>
                  <div id="serialStatus" class="serial-pill">
                    <span class="dot"></span><span class="mono" id="serialStatusText">DISCONNECTED</span>
                  </div>
                </div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">시리얼 수신 로그 반영</div>
                    <div class="hint-mini">보드가 JSON 라인을 출력하면 그대로 파싱해 UI/차트에 반영합니다.</div>
                  </div>
                  <label class="switch" title="Serial RX">
                    <input type="checkbox" id="serialRxToggle" checked>
                    <span class="slider"></span>
                  </label>
                </div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">시리얼 명령 전송</div>
                    <div class="hint-mini">ON이면 /set?… 같은 HTTP 명령을 시리얼 “SET …” 라인으로도 전송합니다.</div>
                  </div>
                  <label class="switch" title="Serial TX">
                    <input type="checkbox" id="serialTxToggle" checked>
                    <span class="slider"></span>
                  </label>
                </div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">폴링 유지</div>
                    <div class="hint-mini">Wi-Fi 연결이 없어도 UI가 멈추지 않도록 폴링은 계속 시도합니다.</div>
                  </div>
                  <span class="settings-desc mono">fetch /data</span>
                </div>
              </div>
            </div>

            <!-- UNITS -->
            <div class="settings-panel" data-panel="units">
              <div class="settings-group">
                <div class="settings-group-title">단위 설정</div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">추력 단위</div>
                    <div class="hint-mini">표시 단위만 변환됩니다. 저장 데이터(RAW)는 <strong>kgf 기준</strong>입니다.</div>
                  </div>
                  <select id="unitThrust" class="settings-select">
                    <option value="kgf">kgf</option>
                    <option value="N">N</option>
                  </select>
                </div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">압력 단위</div>
                    <div class="hint-mini">현재는 Voltage(V) 기준. 센서 보정이 들어가면 kPa/psi로 확장 가능합니다.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SEQUENCE -->
            <div class="settings-panel" data-panel="sequence">
              <div class="settings-group">
                <div class="settings-group-title">점화 시퀀스</div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">점화 시간 (릴레이 ON)</div>
                    <div class="hint-mini">보드에 <span class="mono">/set?ign_ms=...</span> 전송. 과열/인가 시간에 주의.</div>
                  </div>
                  <div class="settings-number-wrap">
                    <input id="ignTimeInput" type="number" min="1" max="10" step="1" class="settings-number">
                    <div class="settings-desc">1~10초</div>
                  </div>
                </div>
              </div>

              <div class="settings-group">
                <div class="settings-group-title">카운트다운</div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">카운트다운 시간</div>
                    <div class="hint-mini">보드에 <span class="mono">/set?cd_ms=...</span> 전송. 인원 통제 시간을 충분히 확보.</div>
                  </div>
                  <div class="settings-number-wrap">
                    <input id="countdownSecInput" type="number" min="3" max="30" step="1" class="settings-number">
                    <div class="settings-desc">3~30초</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SAFETY -->
            <div class="settings-panel" data-panel="safety">
              <div class="settings-group">
                <div class="settings-group-title">SAFETY</div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">RelaySafe (LOCKOUT)</div>
                    <div class="hint-mini">릴레이가 <strong>비정상</strong>일때 모든 제어권한 정지</strong> + 재시작 후 제어 권한 반환</div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="relaySafeToggle" checked>
                    <span class="slider"></span>
                  </label>
                </div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">Igniter Safety Test (IGS)</div>
                    <div class="hint-mini">이그나이터의 결선 확인/테스트</div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="igswitch">
                    <span class="slider"></span>
                  </label>
                </div>

                <div class="settings-row">
                  <div>
                    <div class="settings-label">안전 알림</div>
                    <div class="hint-mini">각종 상태 변화 시 토스트 알림이 표시됩니다. 클릭하면 닫힙니다.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- FW -->
            <div class="settings-panel" data-panel="fw">
              <div class="settings-group">
                <!-- ✅ 여기: "펌웨어" 설정 안에 작은 F 로고 -->
                <div class="fw-head">
                  <img class="fw-f-logo" src="img/Flash_logo.png" alt="F">
                  <div class="settings-group-title" style="margin:0;">FLASH</div>
                </div>

                <div class="settings-row"><div class="settings-label">Program</div><div class="settings-desc">HANWOOL FLASH</div></div>
                <div class="settings-row"><div class="settings-label">Version / Build</div><div class="settings-desc">v6 · B0.3</div></div>
                <div class="settings-row"><div class="settings-label">Build ID</div><div class="settings-desc">2026-ALTIS-YBB</div></div>
                <div class="settings-row"><div class="settings-label">Board</div><div class="settings-desc">ESP32-S3 FLASH-G Board1</div></div>
                <div class="settings-row"><div class="settings-label">Protocol</div><div class="settings-desc">FLASH JSON v1.0</div></div>
                <div class="settings-row">
                  <div>
                    <div class="settings-label">연결</div>
                    <div class="hint-mini">Wi-Fi(SoftAP) + 선택적으로 USB(WebSerial) 병행 가능.</div>
                  </div>
                  <span class="settings-desc mono">AP/USB</span>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="settings-footer"><button id="settingsSave" class="settings-save-btn">저장</button></div>
      </div>
    </div>

    <!-- 시퀀스 스타트 롱프레스 모달 -->
    <div id="confirmOverlay" class="confirm-overlay hidden" style="display:none;">
      <div class="confirm-dialog">
        <div class="confirm-icon"><img src="img/Danger.svg" alt="warning"></div>
        <div class="confirm-title">점화 시퀀스를 진행할까요?</div>
        <div class="confirm-text">
          점화 조건이 충족되지 않으면 보드가 점화를 실행하지 않습니다.<br>
          버튼을 3초 동안 계속 누르고 있어야 카운트다운이 진행됩니다.
        </div>
        <div class="confirm-note">• 주변 안전거리 확보 · 이그나이터 결선/단락 여부 반드시 확인!</div>
        <div class="confirm-actions">
          <div class="longpress-wrap">
            <button id="longPressBtn" class="longpress-btn">
              <span>HOLD<br>TO START</span>
              <div class="longpress-ring"><div class="longpress-spinner"></div></div>
            </button>
          </div>
          <button id="confirmCancel" class="confirm-cancel">취소</button>
        </div>
      </div>
    </div>

    <!-- 강제 점화 모달 -->
    <div id="forceOverlay" class="confirm-overlay hidden" style="display:none;">
      <div class="confirm-dialog">
        <div class="confirm-icon"><img src="img/Danger.svg" alt="warning"></div>
        <div class="confirm-title">강제 점화를 진행할까요?</div>
        <div class="confirm-text">
          강제 점화는 고위험 동작입니다.<br>
          주변 인원 접근 금지 · 보호구 착용 권장 · 결선/단락 재확인.
        </div>
        <div class="force-actions">
          <button id="forceConfirmYes" class="force-danger-small">강제 점화</button>
          <button id="forceConfirmCancel" class="force-cancel-big">취소</button>
        </div>
      </div>
    </div>

    <!-- ✅ LOCKOUT 모달 -->
    <div id="lockoutOverlay" class="confirm-overlay hidden" style="display:none;">
      <div class="confirm-dialog lockout-dialog">
        <button id="lockoutClose" class="settings-close-btn lockout-close" aria-label="close">×</button>

        <div class="lockout-figure">
          <img id="lockoutImg" class="lockout-img" src="" alt="RelaySafe Lockout">
        </div>

        <div class="confirm-title" id="lockoutTitle">LOCKOUT</div>
        <div class="confirm-text" id="lockoutText">
          비정상적인 릴레이 HIGH 감지로 모든 제어 권한이 해제되었습니다.
        </div>
        <div class="confirm-note" id="lockoutNote">
          • 릴레이/배선/드라이버 쇼트 여부 확인 후 <strong>보드를 재시작</strong>하세요.
        </div>

        <div class="confirm-actions">
          <button id="lockoutAck" class="force-danger-small">확인</button>
        </div>
      </div>
    </div>

    <!-- 발사대 모달 -->
    <div id="launcherOverlay" class="settings-overlay hidden">
      <div class="launcher-dialog">
        <div class="launcher-header">
          <div class="launcher-title">LAUNCHER CONTROL</div>
          <button id="launcherClose" class="launcher-close-btn">×</button>
        </div>
        <div class="launcher-note">
          발사대 모터/액추에이터와 연결된 후 실제 높이 제어가 적용됩니다.<br>
          현재는 UI 수준의 제어 모킹입니다.
        </div>
        <div class="launcher-controls">
          <div class="launcher-arrow-row">
            <button id="launcherUpModalBtn" class="launcher-arrow-btn">▲</button>
            <button id="launcherDownModalBtn" class="launcher-arrow-btn">▼</button>
            <div class="launcher-hint">버튼을 누르고 있는 동안 제어 명령이 반복됩니다 (현재는 로그만 기록).</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 설비 점검 모달 -->
    <div id="inspectionOverlay" class="settings-overlay hidden" style="display:none;">
      <div class="inspection-dialog">
        <div class="inspection-header">
          <div>
            <div class="inspection-title">설비 점검</div>
            <div class="inspection-sub">자동 점검을 완료하면 제어 권한이 부여됩니다.</div>
          </div>
          <button id="inspectionClose" class="inspection-close-btn" aria-label="close">×</button>
        </div>

        <div class="inspection-list">
          <div class="inspection-item" data-key="link">
            <div class="inspection-left">
              <span class="inspection-dot"></span>
              <div>
                <div class="inspection-label">데이터 링크</div>
                <div class="inspection-desc">Wi-Fi/폴링 응답 상태</div>
              </div>
            </div>
            <div class="inspection-status">대기</div>
          </div>
          <div class="inspection-item" data-key="serial">
            <div class="inspection-left">
              <span class="inspection-dot"></span>
              <div>
                <div class="inspection-label">WebSerial</div>
                <div class="inspection-desc">USB 시리얼 연결/권한</div>
              </div>
            </div>
            <div class="inspection-status">대기</div>
          </div>
          <div class="inspection-item" data-key="igniter">
            <div class="inspection-left">
              <span class="inspection-dot"></span>
              <div>
                <div class="inspection-label">이그나이터</div>
                <div class="inspection-desc">연속성/오픈 여부</div>
              </div>
            </div>
            <div class="inspection-status">대기</div>
          </div>
          <div class="inspection-item" data-key="switch">
            <div class="inspection-left">
              <span class="inspection-dot"></span>
              <div>
                <div class="inspection-label">스위치</div>
                <div class="inspection-desc">저전위(LOW) 안전 상태</div>
              </div>
            </div>
            <div class="inspection-status">대기</div>
          </div>
          <div class="inspection-item" data-key="relay">
            <div class="inspection-left">
              <span class="inspection-dot"></span>
              <div>
                <div class="inspection-label">RelaySafe/LOCKOUT</div>
                <div class="inspection-desc">비정상 릴레이 HIGH 여부</div>
              </div>
            </div>
            <div class="inspection-status">대기</div>
          </div>
        </div>

        <div class="inspection-footer">
          <div id="inspectionResult" class="inspection-result">점검 대기중…</div>
          <div class="inspection-actions">
            <button id="inspectionRetry" class="toolbar-btn">다시 점검</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer-nav"><div class="footer-meta">2026 ALTIS 추진팀 윤보배 - HANWOOL</div></footer>
  </div>

  <script>
    // =====================
    // 상태/버퍼
    // =====================

    let logLines = [];
    let logData = [];
    let eventLog = [];
    let thrustBaseHistory = [];
    let pressureBaseHistory = [];
    let sampleHistory = [];
    const SAMPLE_HISTORY_MAX = 10000;
    const EVENT_LOG_MAX = 5000;
    const RAW_LOG_MAX   = 20000;

    const IGN_THRUST_THRESHOLD = 2.0;  // kgf
    const IGN_PRE_WINDOW_MS    = 1000;
    const IGN_POST_WINDOW_MS   = 1000;

    let prevStForIgn = 0;
    let ignitionAnalysis = {hasData:false,ignStartMs:null,thresholdMs:null,lastAboveMs:null,windowStartMs:null,windowEndMs:null,delaySec:null,durationSec:null,endNotified:false};

    const MAX_POINTS         = 300;

    // ✅ 너무 빡센 폴링(30ms)은 ESP 쪽 응답 흔들림(간헐 타임아웃/큐 적체)을 만들 수 있어서 완화
    const POLL_INTERVAL      = 80;

    const UI_SAMPLE_SKIP     = 2;
    const CHART_MIN_INTERVAL = 50;

    let lastChartRedraw = 0;
    let sampleCounter = 0;
    let isUpdating = false;
    let chartView = { start: 0, window: 150 };
    let autoScrollChart = true;
    let disconnectedLogged = false;
    let lastStatusCode = -1;
    let currentSt = 0;

    let prevSwState = null;
    let prevIcState = null;
    let prevGsState = null;
    let st2StartMs = null;

    // ✅ RelaySafe/LOCKOUT
    let relaySafeEnabled = true;
    let lockoutLatched = false;
    let lockoutRelayMask = 0; // bit0=rly1, bit1=rly2
    let lastLockoutToastMs = 0;

    // ✅ LOCKOUT modal
    let lockoutModalShown = false;

    // ✅ WebSerial
    let serialEnabled = false;
    let serialRxEnabled = true;
    let serialTxEnabled = true;
    let serialPort = null;
    let serialReader = null;
    let serialWriter = null;
    let serialReadAbort = null;
    let serialLineBuf = "";
    let serialConnected = false;

    // ✅ 설비 점검/제어 권한
    let controlAuthority = false;
    let inspectionState = "idle";
    let inspectionRunning = false;
    let latestTelemetry = {sw:null, ic:null, rly:null, mode:null};
    const INSPECTION_STEPS = [
      {key:"link",    check:()=>connOk},
      {key:"serial",  check:()=>(!serialEnabled) || serialConnected},
      {key:"igniter", check:()=>latestTelemetry.ic===1},
      {key:"switch",  check:()=>latestTelemetry.sw===0},
      {key:"relay",   check:()=>!lockoutLatched},
    ];

    // ✅ DOM 캐시
    const el = {};
    const MAX_VISIBLE_LOG = 500;

    // ✅ 연결 상태 안정화(히스테리시스) - CONNECT/DISCONNECT 깜빡임 방지
    let connOk = false;
    let lastOkMs = Date.now();          // 마지막 정상 샘플 수신 시각
    let failStreak = 0;                // 연속 실패 횟수
    let lastDiscAnnounceMs = 0;

    const DISCONNECT_GRACE_MS = 1500;  // 이 시간 동안 샘플이 없으면 끊김 후보
    const FAIL_STREAK_LIMIT   = 20;    // 연속 실패가 이 이상이고, grace도 지났으면 DISCONNECTED
    const DISC_TOAST_COOLDOWN_MS = 7000;

    // ✅ 엔드포인트 “기억” (매번 3개 다 두드리지 않게)
    let preferredEndpoint = "/graphic_data";
    const ENDPOINTS = ["/graphic_data","/data","/json"];

    // =====================
    // ✅ SPLASH / PRELOAD
    // =====================
    function preloadImages(paths){
      const uniq = Array.from(new Set(paths.filter(Boolean)));
      return Promise.all(uniq.map(src => new Promise(resolve=>{
        const img = new Image();
        img.onload = () => resolve({src, ok:true});
        img.onerror = () => resolve({src, ok:false});
        img.src = src;
      })));
    }

    async function runSplashAndPreload(){
      const splash  = document.getElementById("splash");
      const loading = document.getElementById("splashLoading");
      const dots    = document.getElementById("splashDots");
      const app     = document.querySelector(".page-wrap");

      if(!splash || !loading || !dots || !app){
        app?.classList?.add("ready");
        return;
      }

      // ✅ 타이밍 고정: 로고만 2초 → 로딩중 표시 → (프리로드 완료 후) 넘어감
      const SHOW_LOADING_AFTER_MS = 2000;  // 로고만 보이는 시간
      const HOLD_AFTER_LOADING_MS = 300;   // "로딩중" 최소 체류(너무 휙 넘어가는 느낌 방지)

      // 점 애니메이션
      let n = 0;
      const dotTimer = setInterval(()=>{
        n = (n + 1) % 4;
        dots.textContent = ".".repeat(n);
      }, 320);

      const ASSETS = [
        "img/Flash_logo.png",
        "img/Danger.svg",
        "img/Tick.svg",
        "img/Graph.svg",
        "img/Activity.svg",
        "img/RS_1.svg",
        "img/RS_2.svg",
        "img/RS_all.svg",
      ];

      // ✅ 프리로드는 바로 시작
      const preloadPromise = preloadImages(ASSETS);

      // ✅ 2초는 무조건 기다렸다가 로딩중 표시
      await new Promise(r => setTimeout(r, SHOW_LOADING_AFTER_MS));
      loading.classList.add("show");

      // ✅ 프리로드 끝날 때까지 대기
      await preloadPromise;

      // ✅ 로딩중이 뜬 상태로 너무 바로 꺼지지 않게 살짝 홀드
      await new Promise(r => setTimeout(r, HOLD_AFTER_LOADING_MS));

      clearInterval(dotTimer);
      dots.textContent = "";

      // ✅ 스플래시 종료 → 앱 표시
      splash.classList.add("hide");
      app.classList.add("ready");
      setTimeout(()=>{ try{ splash.remove(); }catch(e){} }, 350);
    }


    // =====================
    // UI 설정 저장
    // =====================
    const SETTINGS_KEY = "hanwool_tms_settings_v2";
    let uiSettings = null;

    function defaultSettings(){
      return {
        thrustUnit:"kgf",
        ignDurationSec:5,
        countdownSec:10,
        relaySafe: true,
        igs: 0,
        serialEnabled: false,
        serialRx: true,
        serialTx: true
      };
    }
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        uiSettings = raw ? Object.assign(defaultSettings(), JSON.parse(raw)) : defaultSettings();
      }catch(e){ uiSettings = defaultSettings(); }
      relaySafeEnabled = !!uiSettings.relaySafe;

      // WebSerial 기본 OFF 강제
      serialEnabled = false;
      uiSettings.serialEnabled = false;
      saveSettings();

      serialRxEnabled = uiSettings.serialRx !== false;
      serialTxEnabled = uiSettings.serialTx !== false;
    }
    function saveSettings(){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(uiSettings)); }catch(e){} }

    function convertThrustForDisplay(t){
      if(!uiSettings) return t;
      return (uiSettings.thrustUnit==="N") ? (t*9.80665) : t;
    }

    function applySettingsToUI(){
      if(!uiSettings) return;
      const thrustLabel = document.querySelector('[data-label="thrust-unit"]');
      const thrustBadge = document.querySelector('[data-badge="thrust-unit"]');
      const pressureBadge = document.querySelector('[data-badge="pressure-unit"]');

      if(thrustLabel) thrustLabel.textContent = uiSettings.thrustUnit;
      if(thrustBadge) thrustBadge.textContent = "RED · " + uiSettings.thrustUnit;
      if(pressureBadge) pressureBadge.textContent = "BLUE · V";

      if(el.unitThrust) el.unitThrust.value = uiSettings.thrustUnit;
      if(el.ignTimeInput) el.ignTimeInput.value = uiSettings.ignDurationSec;
      if(el.countdownSecInput) el.countdownSecInput.value = uiSettings.countdownSec;

      if(el.relaySafeToggle) el.relaySafeToggle.checked = !!uiSettings.relaySafe;
      if(el.igswitch) el.igswitch.checked = !!uiSettings.igs;

      if(el.serialToggle) el.serialToggle.checked = !!uiSettings.serialEnabled;
      if(el.serialRxToggle) el.serialRxToggle.checked = uiSettings.serialRx !== false;
      if(el.serialTxToggle) el.serialTxToggle.checked = uiSettings.serialTx !== false;

      updateRelaySafePill();
      updateSerialPill();
    }
    const delay = (ms)=>new Promise(resolve=>setTimeout(resolve, ms));

    // =====================
    // LOCKOUT helpers
    // =====================
    function relayMaskName(mask){
      if(mask===1) return "RLY1";
      if(mask===2) return "RLY2";
      if(mask===3) return "RLY1+RLY2";
      return "RLY?";
    }
    function setLockoutVisual(on){
      if(!el.lockoutBg) return;
      el.lockoutBg.classList.toggle("active", !!on);
    }

    function lockoutImgSrc(mask){
      if(mask===1) return "img/RS_1.svg";
      if(mask===2) return "img/RS_2.svg";
      if(mask===3) return "img/RS_all.svg";
      return "img/RS_all.svg";
    }
    function showLockoutModal(){
      if(!el.lockoutOverlay) return;

      const name = relayMaskName(lockoutRelayMask);
      const img = lockoutImgSrc(lockoutRelayMask);

      if(el.lockoutImg) el.lockoutImg.src = img;
      if(el.lockoutTitle) el.lockoutTitle.textContent = "LOCKOUT · " + name;
      if(el.lockoutText){
        el.lockoutText.textContent =
          "비정상적인 릴레이 HIGH 감지 ("+name+")로 모든 제어 권한이 해제되었습니다.";
      }
      if(el.lockoutNote){
        el.lockoutNote.innerHTML =
          "• 릴레이/배선/드라이버 쇼트 여부 확인 후 <strong>보드를 재시작</strong>하세요.";
      }

      el.lockoutOverlay.classList.remove("hidden");
      el.lockoutOverlay.style.display = "flex";
      lockoutModalShown = true;
    }
    function hideLockoutModal(){
      if(!el.lockoutOverlay) return;
      el.lockoutOverlay.classList.add("hidden");
      el.lockoutOverlay.style.display = "none";
    }

    // =====================
    // UI 헬퍼
    // =====================
    function updateConnectionUI(connected){
      if(!el.connDot || !el.connText) return;
      if(connected){ el.connDot.classList.add("ok"); el.connText.textContent="CONNECTED"; }
      else { el.connDot.classList.remove("ok"); el.connText.textContent="DISCONNECTED"; }
      updateInspectionAccess();
    }

    function addLogLine(message, tag){
      if(!el.logView) return;
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const timeIso = now.toISOString();
      const prefix = tag ? "[" + tag + "] " : "";
      const lineText = prefix + "[" + timeStr + "] " + message;

      logLines.push(lineText);
      eventLog.push({ time: timeIso, tag: tag || "", message: message });

      if(eventLog.length > EVENT_LOG_MAX) eventLog.splice(0, eventLog.length - EVENT_LOG_MAX);

      const div = document.createElement("div");
      div.className = "log-line";
      div.innerHTML = '<span class="log-prefix">$</span> ' + lineText.replace(/</g,"&lt;").replace(/>/g,"&gt;");
      el.logView.appendChild(div);

      while(el.logView.childNodes.length > MAX_VISIBLE_LOG){
        el.logView.removeChild(el.logView.firstChild);
      }
      while(logLines.length > MAX_VISIBLE_LOG){
        logLines.shift();
      }
      el.logView.scrollTop = el.logView.scrollHeight;
    }

    function getToastIconPath(type){
      if(type==="success") return "img/Tick.svg";
      if(type==="warn") return "img/Danger.svg";
      if(type==="error") return "img/Danger.svg";
      if(type==="ignite") return "img/Graph.svg";
      return "img/Activity.svg";
    }

    function dismissToast(toast){
      if(!toast || toast._dismissed) return;
      toast._dismissed = true;
      if(toast._timer){ clearTimeout(toast._timer); toast._timer = null; }
      toast.classList.remove("toast-show");
      toast.classList.add("toast-hide");
      setTimeout(()=>{ if(toast && toast.parentNode) toast.parentNode.removeChild(toast); }, 220);
    }

    function showToast(message, type, opts){
      if(!el.toastContainer) return;
      const t = type || "info";
      const duration = (opts && opts.duration) ? opts.duration : 5200;

      const toast = document.createElement("div");
      toast.className = "toast toast-" + t;
      toast.setAttribute("role","status");
      toast.setAttribute("aria-live","polite");

      const iconDiv = document.createElement("div");
      iconDiv.className = "toast-icon";
      const img = document.createElement("img");
      img.src = getToastIconPath(t);
      img.alt = "";
      iconDiv.appendChild(img);

      const bodyDiv = document.createElement("div");
      bodyDiv.className = "toast-body";

      const titleDiv = document.createElement("div");
      titleDiv.className = "toast-title";
      if(t==="success") titleDiv.textContent="완료";
      else if(t==="warn") titleDiv.textContent="주의";
      else if(t==="error") titleDiv.textContent="오류";
      else if(t==="ignite") titleDiv.textContent="점화 / 추력 감지";
      else titleDiv.textContent="알림";

      const textDiv = document.createElement("div");
      textDiv.className = "toast-text";
      textDiv.textContent = message;

      bodyDiv.appendChild(titleDiv);
      bodyDiv.appendChild(textDiv);

      toast.appendChild(iconDiv);
      toast.appendChild(bodyDiv);

      toast.addEventListener("click", ()=>dismissToast(toast));
      el.toastContainer.appendChild(toast);
      requestAnimationFrame(()=>toast.classList.add("toast-show"));
      toast._timer = setTimeout(()=>dismissToast(toast), duration);
    }

    function safetyLineSuffix(){
      return "안전거리 확보 · 결선/단락 확인 · 주변 인원 접근 금지.";
    }

    function updateRelaySafePill(){
      if(!el.relaySafePill) return;
      setLockoutVisual(lockoutLatched);

      if(lockoutLatched){
        const name = relayMaskName(lockoutRelayMask);
        el.relaySafePill.textContent = "LOCKOUT(" + name + ")";
        el.relaySafePill.style.color = "#991b1b";
      }else{
        el.relaySafePill.textContent = relaySafeEnabled ? "SAFE" : "OFF";
        el.relaySafePill.style.color = relaySafeEnabled ? "#166534" : "#64748b";
      }
    }

    function updateSerialPill(){
      if(!el.serialStatus || !el.serialStatusText) return;
      const enabled = serialEnabled;
      const ok = enabled && serialConnected;
      el.serialStatus.classList.remove("ok","bad");
      if(!enabled){
        el.serialStatusText.textContent = "OFF";
      }else if(ok){
        el.serialStatus.classList.add("ok");
        el.serialStatusText.textContent = "CONNECTED";
      }else{
        el.serialStatus.classList.add("bad");
        el.serialStatusText.textContent = "DISCONNECTED";
      }
    }

    function isControlUnlocked(){
      return controlAuthority && inspectionState==="passed" && !lockoutLatched;
    }

    function updateInspectionPill(){
      if(!el.inspectionStatusPill) return;
      let cls="pill ";
      let txt="대기";
      if(inspectionState==="passed"){ cls+="pill-green"; txt="OK"; }
      else if(inspectionState==="failed"){ cls+="pill-red"; txt="확인"; }
      else if(inspectionRunning){ cls+="pill-gray"; txt="진행중"; }
      else { cls+="pill-gray"; txt="대기"; }
      el.inspectionStatusPill.className=cls;
      el.inspectionStatusPill.textContent=txt;
    }

    function updateInspectionAccess(){
      if(!el.inspectionOpenBtn) return;
      const blocked = !connOk;
      el.inspectionOpenBtn.classList.toggle("disabled", blocked);
      el.inspectionOpenBtn.setAttribute("aria-disabled", blocked ? "true" : "false");
    }

    function updateControlAccessUI(st){
      const state = (st==null) ? currentSt : st;
      const unlocked=isControlUnlocked();
      if(el.forceBtn){
        const blocked = (!unlocked || lockoutLatched || state!==0);
        el.forceBtn.disabled = blocked;
        el.forceBtn.classList.toggle("disabled", blocked);
      }
      if(el.launcherOpenBtn){
        const blocked = (!unlocked || lockoutLatched);
        el.launcherOpenBtn.classList.toggle("disabled", blocked);
        el.launcherOpenBtn.setAttribute("aria-disabled", blocked ? "true" : "false");
      }
      updateInspectionPill();
    }

    function setInspectionItemState(key,state,label){
      const item=document.querySelector('.inspection-item[data-key="'+key+'"]');
      if(!item) return;
      item.classList.remove("state-running","state-ok","state-bad");
      if(state==="running") item.classList.add("state-running");
      else if(state==="ok") item.classList.add("state-ok");
      else if(state==="bad") item.classList.add("state-bad");
      const status=item.querySelector(".inspection-status");
      if(status){
        status.textContent = label || (state==="ok" ? "정상" : state==="bad" ? "확인 필요" : "진행중");
      }
    }

    function setInspectionResult(text, state){
      if(!el.inspectionResult) return;
      el.inspectionResult.classList.remove("ok","error","running");
      if(state) el.inspectionResult.classList.add(state);
      el.inspectionResult.textContent=text;
    }

    function resetInspectionUI(){
      inspectionRunning=false;
      controlAuthority=false;
      inspectionState="idle";
      INSPECTION_STEPS.forEach(s=>setInspectionItemState(s.key,"", "대기"));
      setInspectionResult("점검 대기중…","neutral");
      updateInspectionPill();
      updateControlAccessUI(currentSt);
    }

    async function runInspectionSequence(){
      if(inspectionRunning) return;
      inspectionRunning=true;
      inspectionState="running";
      controlAuthority=false;
      updateInspectionPill();
      setInspectionResult("점검 중…","running");
      updateControlAccessUI(currentSt);

      let hasFail=false;
      for(const step of INSPECTION_STEPS){
        setInspectionItemState(step.key,"running","확인 중");
        await delay(320);
        let ok=false;
        try{ ok = !!step.check(); }catch(e){ ok=false; }
        setInspectionItemState(step.key, ok ? "ok" : "bad", ok ? "정상" : "확인 필요");
        if(!ok) hasFail=true;
        await delay(180);
      }

      inspectionRunning=false;
      inspectionState = hasFail ? "failed" : "passed";

      if(hasFail){
        controlAuthority=false;
        setInspectionResult("점검 실패 항목이 있습니다.","error");
        showToast("점검 실패 항목이 있습니다. 상태를 확인하세요.","warn");
        addLogLine("설비 점검 실패: 일부 항목이 통과하지 못했습니다.","SAFE");
      }else{
        controlAuthority=true;
        setInspectionResult("모든 항목 통과. 제어 권한 확보됨.","ok");
        showToast("설비 점검 통과. 제어 권한을 획득했습니다.","success");
        addLogLine("설비 점검 완료. 제어 권한을 획득했습니다.","SAFE");
      }
      setButtonsFromState(currentSt, lockoutLatched);
      updateInspectionPill();
    }

    function showInspection(){
      if(el.inspectionOverlay){
        el.inspectionOverlay.classList.remove("hidden");
        el.inspectionOverlay.style.display="flex";
      }
      resetInspectionUI();
      runInspectionSequence();
    }
    function hideInspection(){
      if(el.inspectionOverlay){
        el.inspectionOverlay.classList.add("hidden");
        el.inspectionOverlay.style.display="none";
      }
    }

    function colorToRgba(hex, alpha){
      if(!hex) hex="#000000";
      if(hex[0]==="#") hex=hex.substring(1);
      if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
      const r=parseInt(hex.substring(0,2),16)||0;
      const g=parseInt(hex.substring(2,4),16)||0;
      const b=parseInt(hex.substring(4,6),16)||0;
      return "rgba("+r+","+g+","+b+","+alpha+")";
    }

    function getViewIndices(data, view){
      const len=data.length;
      if(len===0) return {start:0,end:-1};
      let windowSize=view.window||len;
      if(windowSize<2) windowSize=2;
      if(windowSize>len) windowSize=len;
      let start=view.start||0;
      if(start<0) start=0;
      if(start+windowSize>len) start=len-windowSize;
      return {start:start,end:start+windowSize-1};
    }

    // =====================
    // 캔버스 DPR 보정
    // =====================
    function ensureCanvasSize(canvas){
      const rect = canvas.getBoundingClientRect();
      const cssW = Math.max(160, rect.width || (canvas.parentElement?.clientWidth || 200));
      const cssH = Math.max(180, rect.height || 220);
      const dpr  = window.devicePixelRatio || 1;

      if(canvas._cssW!==cssW || canvas._cssH!==cssH || canvas._dpr!==dpr){
        canvas.style.width  = cssW + "px";
        canvas.style.height = cssH + "px";
        canvas.width  = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);
        canvas._cssW = cssW; canvas._cssH = cssH; canvas._dpr = dpr;
      }
      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return { w: cssW, h: cssH, ctx };
    }

    // =====================
    // 차트
    // =====================
    function drawChart(canvasId, data, color, view){
      const canvas=document.getElementById(canvasId);
      if(!canvas) return;

      const { w:width, h:height, ctx } = ensureCanvasSize(canvas);
      ctx.clearRect(0,0,width,height);

      if(!data || data.length<2) return;
      const indices=getViewIndices(data,view);
      if(indices.end<indices.start) return;

      const slice=data.slice(indices.start,indices.end+1);
      if(slice.length<2) return;

      let min=slice[0], max=slice[0], sum=0;
      for(let v of slice){ if(v<min) min=v; if(v>max) max=v; sum+=v; }
      const avg=sum/slice.length;

      const padding=6;
      let range=max-min; if(range===0) range=1;
      const count=slice.length;
      const stepX=(width-2*padding)/(count-1);

      function yPos(value){
        return (height-padding) - ((value-min)/range)*(height-2*padding);
      }

      ctx.save();
      ctx.strokeStyle="rgba(148,163,184,0.35)";
      ctx.lineWidth=1;
      ctx.setLineDash([3,4]);
      for(let i=0;i<=4;i++){
        let y=padding+(height-2*padding)*(i/4);
        y=height-y;
        ctx.beginPath(); ctx.moveTo(padding,y); ctx.lineTo(width-padding,y); ctx.stroke();
      }
      ctx.setLineDash([2,6]);
      for(let i=0;i<=4;i++){
        let x=padding+(width-2*padding)*(i/4);
        ctx.beginPath(); ctx.moveTo(x,padding); ctx.lineTo(x,height-padding); ctx.stroke();
      }
      ctx.restore();

      ctx.beginPath();
      for(let i=0;i<slice.length;i++){
        const x=padding+i*stepX;
        const y=yPos(slice[i]);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.strokeStyle=color;
      ctx.lineWidth=2;
      ctx.stroke();

      const lastX=padding+(slice.length-1)*stepX;
      const bottomY=height-padding;
      ctx.lineTo(lastX,bottomY);
      ctx.lineTo(padding,bottomY);
      ctx.closePath();

      const grad=ctx.createLinearGradient(0,0,0,height);
      grad.addColorStop(0,colorToRgba(color,0.35));
      grad.addColorStop(0.5,colorToRgba(color,0.18));
      grad.addColorStop(1,colorToRgba(color,0));
      ctx.fillStyle=grad;
      ctx.fill();

      const yAvg=yPos(avg);
      ctx.save();
      ctx.setLineDash([6,4]);
      ctx.strokeStyle=colorToRgba(color,0.7);
      ctx.lineWidth=1.4;
      ctx.beginPath(); ctx.moveTo(padding,yAvg); ctx.lineTo(width-padding,yAvg); ctx.stroke();
      ctx.restore();

      const yMax=yPos(max);
      ctx.save();
      ctx.setLineDash([3,3]);
      ctx.strokeStyle=colorToRgba(color,0.9);
      ctx.lineWidth=1.2;
      ctx.beginPath(); ctx.moveTo(padding,yMax); ctx.lineTo(width-padding,yMax); ctx.stroke();
      ctx.restore();

      ctx.save();
      ctx.font="10px -apple-system,BlinkMacSystemFont,system-ui,sans-serif";
      ctx.fillStyle=colorToRgba(color,0.9);
      ctx.textAlign="right";
      ctx.textBaseline="bottom";
      ctx.fillText("AVG "+avg.toFixed(3),width-padding-2,yAvg-2);
      ctx.textBaseline="top";
      ctx.fillText("MAX "+max.toFixed(3),width-padding-2,yMax+2);
      ctx.restore();
    }

    function redrawCharts(){
      const thrustDisplay=thrustBaseHistory.map(convertThrustForDisplay);
      const pressureDisplay=pressureBaseHistory.slice();
      drawChart("thrustChart", thrustDisplay, "#ef4444", chartView);
      drawChart("pressureChart", pressureDisplay, "#3b82f6", chartView);
    }

    // =====================
    // 상태/버튼
    // =====================
    function setStatusFromState(st, ignOK, aborted, lockout){
      if(!el.statusPill||!el.statusText) return 0;

      if(lockout){
        el.statusPill.className="status-lock";
        el.statusPill.textContent="LOCKOUT";
        const name = relayMaskName(lockoutRelayMask);
        el.statusText.textContent="비정상적인 릴레이 HIGH 감지 ("+name+"). 모든 제어 권한이 해제되었습니다. 보드를 재시작하세요.";
        return 9;
      }
      if(aborted){
        el.statusPill.className="status-abort"; el.statusPill.textContent="ABORT"; el.statusText.textContent="Sequence aborted"; return 4;
      }
      if(st===2){
        el.statusPill.className="status-fire"; el.statusPill.textContent="IGNITION"; el.statusText.textContent="Igniter firing"; return 2;
      }
      if(st===1){
        el.statusPill.className="status-count"; el.statusPill.textContent="COUNTDOWN"; el.statusText.textContent="Launch countdown in progress"; return 1;
      }
      if(!ignOK){
        el.statusPill.className="status-disc"; el.statusPill.textContent="NOT ARMED"; el.statusText.textContent="Igniter open / not ready"; return 3;
      }
      el.statusPill.className="status-ready"; el.statusPill.textContent="READY"; el.statusText.textContent="System ready"; return 0;
    }

    function setButtonsFromState(st, lockout){
      if(!el.igniteBtn||!el.abortBtn){ updateControlAccessUI(st); return; }
      if(lockout){
        el.igniteBtn.disabled=true;
        el.abortBtn.disabled=true;
        updateControlAccessUI(st);
        return;
      }
      if(!isControlUnlocked()){
        el.igniteBtn.disabled=true;
        el.abortBtn.disabled = (st===0);
        updateControlAccessUI(st);
        return;
      }
      if(st===0){ el.igniteBtn.disabled=false; el.abortBtn.disabled=true; }
      else { el.igniteBtn.disabled=true; el.abortBtn.disabled=false; }
      updateControlAccessUI(st);
    }

    // =====================
    // 통신: Wi-Fi 폴링
    // =====================
    async function fetchJsonTimeout(url, timeoutMs){
      const ctrl = new AbortController();
      const t = setTimeout(()=>{ try{ ctrl.abort(); }catch(e){} }, timeoutMs);
      try{
        const resp = await fetch(url, { cache:"no-cache", signal: ctrl.signal });
        if(!resp.ok) throw new Error("HTTP " + resp.status);
        return await resp.json();
      }finally{
        clearTimeout(t);
      }
    }

    async function fetchJsonWithFallback(){
      const order = [preferredEndpoint, ...ENDPOINTS.filter(e=>e!==preferredEndpoint)];
      let lastErr = null;

      for(const url of order){
        try{
          const obj = await fetchJsonTimeout(url, 700);
          preferredEndpoint = url;
          return obj;
        }catch(e){
          lastErr = e;
        }
      }
      throw (lastErr || new Error("no valid endpoint"));
    }

    function markDisconnectedIfNeeded(reason){
      const now = Date.now();
      const sinceOk = now - (lastOkMs || 0);

      if(sinceOk > DISCONNECT_GRACE_MS && failStreak >= FAIL_STREAK_LIMIT){
        if(connOk){
          connOk = false;
          updateConnectionUI(false);
        }

        if(el.statusPill && el.statusText && !lockoutLatched){
          el.statusPill.className="status-disc";
          el.statusPill.textContent="DISCONNECTED";
          el.statusText.textContent = reason || "No response from board";
        }

        if(!disconnectedLogged){
          addLogLine("Dashboard lost connection to board.", "DISC");
          disconnectedLogged = true;
        }

        if(now - lastDiscAnnounceMs > DISC_TOAST_COOLDOWN_MS){
          lastDiscAnnounceMs = now;
          showToast("보드 응답이 불안정합니다. 전원/배선/Wi-Fi/폴링 주기를 확인하세요.", "warn");
        }
      }
    }

    // =====================
    // WebSerial helpers
    // =====================
    function serialSupported(){ return !!(navigator && navigator.serial); }

    async function serialConnect(){
      if(!serialSupported()){
        showToast("이 브라우저는 WebSerial을 지원하지 않습니다. (Chrome/Edge 권장)", "warn");
        return;
      }
      try{
        serialPort = await navigator.serial.requestPort({});
        await serialPort.open({ baudRate: 460800 });
        serialWriter = serialPort.writable?.getWriter?.() || null;

        serialReadAbort = new AbortController();
        serialReader = serialPort.readable?.getReader?.({ signal: serialReadAbort.signal }) || null;
        serialConnected = true;
        updateSerialPill();

        addLogLine("WebSerial connected @460800.", "SER");
        showToast("시리얼(WebSerial) 연결 완료.", "success");

        if(serialReader){
          readSerialLoop().catch(err=>{
            addLogLine("Serial read loop ended: " + (err?.message||err), "SER");
          });
        }
      }catch(e){
        serialConnected = false;
        updateSerialPill();
        addLogLine("WebSerial connect failed: " + (e?.message || e), "SER");
        showToast("시리얼 연결 실패. 포트/권한을 확인하세요.", "error");
      }
    }

    async function serialDisconnect(){
      try{
        if(serialReadAbort){ try{ serialReadAbort.abort(); }catch(e){} serialReadAbort=null; }
        if(serialReader){ try{ await serialReader.cancel(); }catch(e){} try{ serialReader.releaseLock(); }catch(e){} serialReader=null; }
        if(serialWriter){ try{ serialWriter.releaseLock(); }catch(e){} serialWriter=null; }
        if(serialPort){ try{ await serialPort.close(); }catch(e){} serialPort=null; }
      }finally{
        serialConnected = false;
        updateSerialPill();
        addLogLine("WebSerial disconnected.", "SER");
      }
    }

    async function serialWriteLine(line){
      if(!serialConnected || !serialWriter) return false;
      try{
        const data = new TextEncoder().encode(line.endsWith("\n") ? line : (line + "\n"));
        await serialWriter.write(data);
        return true;
      }catch(e){
        addLogLine("Serial write failed: " + (e?.message||e), "SER");
        return false;
      }
    }

    async function readSerialLoop(){
      const decoder = new TextDecoder();
      while(serialReader){
        const { value, done } = await serialReader.read();
        if(done) break;
        if(!value) continue;

        if(!serialRxEnabled) continue;

        const chunk = decoder.decode(value, { stream:true });
        serialLineBuf += chunk;

        let idx;
        while((idx = serialLineBuf.indexOf("\n")) >= 0){
          const line = serialLineBuf.slice(0, idx).trim();
          serialLineBuf = serialLineBuf.slice(idx+1);
          if(!line) continue;
          if(line[0] === "{" && line[line.length-1] === "}"){
            try{
              const obj = JSON.parse(line);
              onIncomingSample(obj, "SER");
            }catch(e){}
          }
        }
      }
    }

    // =====================
    // 공통: 샘플 수신 처리
    // =====================
    function onIncomingSample(data, srcTag){
      const nowOk = Date.now();
      lastOkMs = nowOk;
      failStreak = 0;

      if(!connOk){
        connOk = true;
        disconnectedLogged = false;
        updateConnectionUI(true);
        addLogLine("Link established (" + srcTag + ").", "NET");
        showToast("보드와 연결되었습니다. (" + srcTag + ")", "success", {duration:2600});
      }

      sampleCounter++;

      const nowDate=new Date();
      const timeMs=nowDate.getTime();
      const timeIso=nowDate.toISOString();

      const t   = Number(data.t  != null ? data.t  : (data.thrust   ?? 0));
      const p   = Number(data.p  != null ? data.p  : (data.pressure ?? 0));
      const lt  = Number(data.lt != null ? data.lt : (data.loop ?? data.loopTime ?? 0));

      const hxHz = Number(data.hz != null ? data.hz : (data.hx_hz ?? 0));
      const ctUs = Number(data.ct != null ? data.ct : (data.cpu_us ?? data.cpu ?? 0));

      const sw  = (data.s  != null ? data.s  : data.sw  ?? 0);
      const ic  = (data.ic != null ? data.ic : data.ign ?? 0);
      const rly = (data.r  != null ? data.r  : data.rly ?? 0);
      const st  = Number(data.st != null ? data.st : (data.state ?? 0));
      const cd  = (data.cd != null ? Number(data.cd) : null);
      const uw  = Number(data.uw ?? 0);
      const ab  = Number(data.ab != null ? data.ab : 0);
      const gs  = Number(data.gs != null ? data.gs : data.igs ?? 0);
      const mode = Number(data.m != null ? data.m : data.mode ?? -1);

      // ✅ LOCKOUT 필드 매칭(펌웨어: rf/rm 우선)
      const lko = Number(data.lko ?? data.lockout ?? data.rf ?? 0);
      const rm  = Number(data.rm  ?? data.rmask   ?? data.rm ?? 0);

      currentSt=st;
      if(st===2 && st2StartMs===null) st2StartMs=Date.now();
      if(st!==2) st2StartMs=null;
      latestTelemetry = {sw: sw?1:0, ic: ic?1:0, rly: rly?1:0, mode, gs};

      thrustBaseHistory.push(t);
      pressureBaseHistory.push(p);

      const maxKeep=MAX_POINTS*4;
      if(thrustBaseHistory.length>maxKeep){
        const remove=thrustBaseHistory.length-maxKeep;
        thrustBaseHistory.splice(0,remove);
        pressureBaseHistory.splice(0,remove);
        chartView.start=Math.max(0,chartView.start-remove);
      }

      sampleHistory.push({timeMs,timeIso,t,p,lt,hz:hxHz,ct:ctUs,sw:sw?1:0,ic:ic?1:0,r:rly?1:0,st,cd:cd??0});
      if(sampleHistory.length>SAMPLE_HISTORY_MAX){
        const remove=sampleHistory.length-SAMPLE_HISTORY_MAX;
        sampleHistory.splice(0,remove);
      }

      logData.push({time:timeIso,t,p,lt,hz:hxHz,ct:ctUs,s:sw?1:0,ic:ic?1:0,r:rly?1:0,gs,st,cd:cd??0});
      if(logData.length > RAW_LOG_MAX) logData.splice(0, logData.length - RAW_LOG_MAX);

      // ✅ LOCKOUT 반영(보드가 내보내면)
      if(lko === 1){
        if(!lockoutLatched){
          lockoutLatched = true;
          lockoutRelayMask = rm || 0;
          controlAuthority = false;
          inspectionState = "failed";

          const name = relayMaskName(lockoutRelayMask);
          setLockoutVisual(true);

          addLogLine("LOCKOUT: abnormal relay HIGH detected ("+name+"). Control revoked. Restart required.", "SAFE");
          showToast(
            "비정상적인 릴레이 HIGH 감지 ("+name+"). 모든 제어 권한이 해제되었습니다. 보드를 재시작하세요.",
            "error",
            {duration:12000}
          );

          showLockoutModal();
        }
        updateControlAccessUI(currentSt);
      }

      // 점화 분석
      if(st===2 && prevStForIgn!==2){
        ignitionAnalysis={hasData:false,ignStartMs:timeMs,thresholdMs:null,lastAboveMs:null,windowStartMs:null,windowEndMs:null,delaySec:null,durationSec:null,endNotified:false};
        addLogLine("Ignition signal detected (st=2). Tracking thrust over "+IGN_THRUST_THRESHOLD.toFixed(2)+" kgf.","IGN");
      }

      if(ignitionAnalysis.ignStartMs!=null && t>=IGN_THRUST_THRESHOLD){
        if(ignitionAnalysis.thresholdMs==null){
          ignitionAnalysis.thresholdMs=timeMs;
          ignitionAnalysis.delaySec=(ignitionAnalysis.thresholdMs-ignitionAnalysis.ignStartMs)/1000.0;
          addLogLine("Thrust exceeded "+IGN_THRUST_THRESHOLD.toFixed(2)+" kgf. Ignition delay = "+ignitionAnalysis.delaySec.toFixed(3)+" s","IGN");
          showToast("추력이 임계값("+IGN_THRUST_THRESHOLD.toFixed(2)+" kgf) 이상으로 감지되었습니다. 점화 지연 ≈ "+ ignitionAnalysis.delaySec.toFixed(3) + "s. " + safetyLineSuffix(),"ignite");
        }
        ignitionAnalysis.lastAboveMs=timeMs;
        ignitionAnalysis.durationSec=Math.max(0,(ignitionAnalysis.lastAboveMs-ignitionAnalysis.thresholdMs)/1000.0);
        ignitionAnalysis.hasData=true;
      }

      if(prevStForIgn===2 && st!==2 && ignitionAnalysis.ignStartMs!=null && !ignitionAnalysis.endNotified){
        ignitionAnalysis.endNotified=true;
        if(ignitionAnalysis.durationSec!=null){
          addLogLine("Ignition state finished. Burn duration ≈ "+ignitionAnalysis.durationSec.toFixed(3)+" s","IGN");
          showToast("유효추력 구간이 종료된 것으로 보입니다. 잔열/잔류가스 주의 후 접근하세요.","info");
        }else{
          addLogLine("Ignition state finished. No thrust over threshold detected.","IGN");
          showToast("점화 상태 종료. 유효추력이 감지되지 않았습니다. 결선/이그나이터 상태를 확인하세요. "+safetyLineSuffix(),"warn");
        }
      }
      prevStForIgn=st;

      // UI 업데이트(스킵)
      if(sampleCounter % UI_SAMPLE_SKIP === 0){
        updateConnectionUI(true);
        disconnectedLogged=false;

        if(prevSwState===null) prevSwState=!!sw;
        else if(prevSwState!==!!sw){
          prevSwState=!!sw;
          if(prevSwState){
            addLogLine("Switch changed: HIGH (ON).", "SW");
            showToast("스위치가 HIGH(ON) 상태입니다. 시퀀스 조건/주변 안전을 재확인하세요. "+safetyLineSuffix(),"warn");
          }else{
            addLogLine("Switch changed: LOW (OFF).", "SW");
            showToast("스위치가 LOW(OFF) 상태입니다. 안전 상태로 유지하세요. "+safetyLineSuffix(),"info");
          }
        }

        if(prevIcState===null) prevIcState=!!ic;
        else if(prevIcState!==!!ic){
          prevIcState=!!ic;
          if(prevIcState){
            addLogLine("Igniter continuity: OK.", "IGN");
            showToast("Igniter 상태가 OK로 변경되었습니다. 점화 전 결선/단락/극성을 재확인하세요. "+safetyLineSuffix(),"success");
          }else{
            addLogLine("Igniter continuity: NO / OPEN.", "IGN");
            showToast("Igniter가 NO(OPEN) 상태입니다. 커넥터/배선/단선 여부를 확인하세요. "+safetyLineSuffix(),"warn");
          }
        }

        if(prevGsState===null) prevGsState=!!gs;
        else if(prevGsState!==!!gs){
          prevGsState=!!gs;
          if(prevGsState){
            addLogLine("Igniter Safety Test: ON (from board).", "SAFE");
            showToast("Igniter Safety Test가 ON입니다. 의도치 않은 인가 위험이 있습니다. "+safetyLineSuffix(),"warn");
          }else{
            addLogLine("Igniter Safety Test: OFF (from board).", "SAFE");
            showToast("Igniter Safety Test가 OFF입니다. 안전 상태로 복귀했습니다. "+safetyLineSuffix(),"info");
          }
        }

        const thrustDisp=convertThrustForDisplay(t);
        const thrustUnit = (uiSettings && uiSettings.thrustUnit) ? uiSettings.thrustUnit : "kgf";

        if(el.thrust)   el.thrust.innerHTML   = `<span class="num">${thrustDisp.toFixed(3)}</span><span class="unit">${thrustUnit}</span>`;
        if(el.pressure) el.pressure.innerHTML = `<span class="num">${p.toFixed(3)}</span><span class="unit">V</span>`;
        if(el.lt)       el.lt.innerHTML       = `<span class="num">${lt.toFixed(0)}</span><span class="unit">ms</span>`;

        if(el.loopPill) el.loopPill.textContent = lt.toFixed(0) + " ms";
        if(el.snapHz){
          const snapHz = (lt>0) ? (1000/lt) : 0;
          el.snapHz.textContent = (snapHz>0 && isFinite(snapHz)) ? (snapHz.toFixed(1) + " Hz") : "-- Hz";
        }
        if(el.hxHz) el.hxHz.textContent = (hxHz>0 && isFinite(hxHz)) ? (hxHz.toFixed(0) + " Hz") : "-- Hz";
        if(el.cpuUs) el.cpuUs.textContent = (ctUs>0 && isFinite(ctUs)) ? (ctUs.toFixed(0) + " us") : "-- us";

        if(el.ignDelayDisplay) el.ignDelayDisplay.textContent = (ignitionAnalysis.delaySec!=null) ? ("Delay "+ignitionAnalysis.delaySec.toFixed(3)+"s") : "Delay --.-s";
        if(el.burnDurationDisplay) el.burnDurationDisplay.textContent = (ignitionAnalysis.durationSec!=null) ? ("Burn "+ignitionAnalysis.durationSec.toFixed(3)+"s") : "Burn --.-s";

        if(el.modePill){
          let label="-";
          if(mode===0) label="SERIAL";
          else if(mode===1) label="WIFI";
          else if(mode===2) label="AUTO";
          el.modePill.textContent=label;
        }

        updateRelaySafePill();

        if(el.sw){
          if(sw){ el.sw.textContent="HIGH"; el.sw.className="pill pill-green"; }
          else { el.sw.textContent="LOW"; el.sw.className="pill pill-gray"; }
        }

        if(el.ic){
          if(ic){ el.ic.textContent="OK"; el.ic.className="pill pill-green"; }
          else { el.ic.textContent="NO"; el.ic.className="pill pill-red"; }
        }

        if(el.relay){
          if(rly){ el.relay.textContent="ON"; el.relay.className="pill pill-green"; }
          else { el.relay.textContent="OFF"; el.relay.className="pill pill-gray"; }
        }

        if(el.igswitch) el.igswitch.checked=!!gs;

        if(el.countdown){
          let cdText="--";
          if(st===1 && cd!==null){
            let sec=Math.ceil(cd/1000); if(sec<0) sec=0;
            cdText=sec;
          }
          el.countdown.innerHTML=cdText+"<span>s</span>";
        }

        const statusCode=setStatusFromState(st,!!ic,!!ab,lockoutLatched);
        setButtonsFromState(st, lockoutLatched);

        if(statusCode!==lastStatusCode){
          if(statusCode===1){
            addLogLine("Countdown started (st=1).","COUNT");
            showToast("카운트다운이 시작되었습니다. 주변 안전거리 확보 후 진행하세요. "+safetyLineSuffix(),"warn");
          }else if(statusCode===2){
            addLogLine("Ignition firing (st=2).","IGNITE");
            showToast("점화 시퀀스가 진행 중입니다. 절대 접근하지 마세요. "+safetyLineSuffix(),"ignite");
          }else if(statusCode===0 && lastStatusCode===2){
            addLogLine("Sequence complete. Back to idle.","DONE");
            showToast("시퀀스가 완료되었습니다. 잔열/잔류가스 주의 후 접근하세요.","success");
          }else if(statusCode===4){
            addLogLine("Sequence aborted.","ABORT");
            showToast("ABORT 처리되었습니다. 재시도 전 결선/스위치/환경을 다시 확인하세요. "+safetyLineSuffix(),"error");
          }else if(statusCode===3){
            showToast("NOT ARMED 상태입니다. 이그나이터 연결 상태를 확인하세요. "+safetyLineSuffix(),"warn");
          }else if(statusCode===9){
            const now = Date.now();
            if(now - lastLockoutToastMs > 5000){
              lastLockoutToastMs = now;
              const name = relayMaskName(lockoutRelayMask);
              showToast("비정상적인 릴레이 HIGH 감지 ("+name+"). 모든 제어가 정지됩니다. 보드를 재시작하세요.", "error", {duration:12000});
            }
          }
          lastStatusCode=statusCode;
        }

        if(autoScrollChart){
          const len=thrustBaseHistory.length;
          let windowSize=chartView.window||150;
          if(windowSize<10) windowSize=10;
          if(windowSize>MAX_POINTS) windowSize=MAX_POINTS;
          if(windowSize>len) windowSize=len;
          chartView.window=windowSize;
          chartView.start=Math.max(0,len-windowSize);
        }

        const nowPerf=(typeof performance!=="undefined" && performance.now) ? performance.now() : Date.now();
        if(nowPerf-lastChartRedraw>=CHART_MIN_INTERVAL){
          redrawCharts();
          lastChartRedraw=nowPerf;
        }
      }
    }

    // =====================
    // Wi-Fi 폴링 루프
    // =====================
    async function updateData(){
      if(isUpdating) return;
      isUpdating=true;
      try{
        let data;
        try{
          data=await fetchJsonWithFallback();
        }catch(err){
          failStreak++;
          markDisconnectedIfNeeded("No response from board");
          return;
        }
        onIncomingSample(data, "WIFI");
      }finally{
        isUpdating=false;
      }
    }

    let pollTimer=null;
    async function pollLoop(){
      const t0 = (performance?.now?.() ?? Date.now());
      try{ await updateData(); }
      catch(e){
        addLogLine("Polling error: " + (e?.message || e), "ERROR");
        showToast("폴링 중 오류가 발생했습니다. 로그를 확인하세요.", "error");
      }
      const t1 = (performance?.now?.() ?? Date.now());
      const dt = t1 - t0;

      const sinceOk = Date.now() - (lastOkMs || 0);
      const extraBackoff = (sinceOk > DISCONNECT_GRACE_MS) ? 120 : 0;

      const delay = Math.max(0, (POLL_INTERVAL + extraBackoff) - dt);
      pollTimer = setTimeout(pollLoop, delay);
    }

    // =====================
    // 터치 줌/팬
    // =====================
    let isPanning=false;
    let isPinching=false;
    let panStartX=0;
    let panStartStart=0;
    let pinchStartDist=0;
    let pinchStartWindow=MAX_POINTS;

    function attachTouch(canvasId){
      const canvas=document.getElementById(canvasId);
      if(!canvas) return;

      canvas.addEventListener("touchstart",(ev)=>{
        autoScrollChart=false;
        if(ev.touches.length===1){
          isPanning=true;isPinching=false;
          panStartX=ev.touches[0].clientX;
          panStartStart=chartView.start||0;
        }else if(ev.touches.length>=2){
          isPinching=true;isPanning=false;
          const dx=ev.touches[0].clientX-ev.touches[1].clientX;
          const dy=ev.touches[0].clientY-ev.touches[1].clientY;
          pinchStartDist=Math.sqrt(dx*dx+dy*dy)||1;
          pinchStartWindow=chartView.window||MAX_POINTS;
        }
        ev.preventDefault();
      },{passive:false});

      canvas.addEventListener("touchmove",(ev)=>{
        if(isPanning && ev.touches.length===1){
          const dx=ev.touches[0].clientX-panStartX;
          const width=canvas.clientWidth||200;
          const ratio=width ? dx/width : 0;
          const delta=Math.round(-ratio*(chartView.window||MAX_POINTS)*0.8);
          chartView.start=panStartStart+delta;
          redrawCharts();
        }else if(isPinching && ev.touches.length>=2){
          const dx=ev.touches[0].clientX-ev.touches[1].clientX;
          const dy=ev.touches[0].clientY-ev.touches[1].clientY;
          const dist=Math.sqrt(dx*dx+dy*dy)||1;
          const scale=pinchStartDist/dist;
          let newWindow=Math.round(pinchStartWindow*scale);
          if(newWindow<10) newWindow=10;
          if(newWindow>MAX_POINTS) newWindow=MAX_POINTS;
          chartView.window=newWindow;
          redrawCharts();
        }
        ev.preventDefault();
      },{passive:false});

      canvas.addEventListener("touchend",(ev)=>{
        if(ev.touches.length===0){ isPanning=false; isPinching=false; }
      });
    }

    // =====================
    // 롱프레스 / 오버레이
    // =====================
    let lpTimer=null;
    let lpStart=0;
    const LP_DURATION=3000;
    let longPressSpinnerEl=null;
    let confirmOverlayEl=null;
    let confirmTitleEl=null;
    let lpLastSentSec=3;
    let userWaitingLocal=false;

    let forceOverlayEl=null;
    let launcherOverlayEl=null;
    let launcherUpHold=null;
    let launcherDownHold=null;

    function resetLongPressVisual(){
      if(longPressSpinnerEl) longPressSpinnerEl.style.setProperty("--lp-angle","0deg");
      if(confirmTitleEl) confirmTitleEl.textContent="점화 시퀀스를 진행할까요?";
    }
    function hideConfirm(){
      if(lpTimer){ clearInterval(lpTimer); lpTimer=null; }
      resetLongPressVisual();
      userWaitingLocal=false;
      if(confirmOverlayEl){ confirmOverlayEl.classList.add("hidden"); confirmOverlayEl.style.display="none"; }
      sendCommand({http:"/precount?uw=0&cd=0", ser:"PRECOUNT 0 0"}, false);
    }
    function showConfirm(){
      if(lockoutLatched){
        showToast("LOCKOUT 상태에서는 어떤 제어도 불가능합니다. 보드를 재시작하세요.", "error");
        return;
      }
      if(!isControlUnlocked()){
        showToast("설비 점검을 먼저 완료하세요. 점검 통과 후 제어 권한이 부여됩니다.", "warn");
        return;
      }
      if(lpTimer){ clearInterval(lpTimer); lpTimer=null; }
      resetLongPressVisual();
      userWaitingLocal=true;
      lpLastSentSec=3;
      if(confirmOverlayEl){ confirmOverlayEl.classList.remove("hidden"); confirmOverlayEl.style.display="flex"; }
      sendCommand({http:"/precount?uw=1&cd=3000", ser:"PRECOUNT 1 3000"}, false);
      showToast("시퀀스 시작 전 최종 안전 확인을 진행하세요. 3초 롱프레스로 진입합니다. "+safetyLineSuffix(),"warn");
    }

    function startHold(){
      if(lockoutLatched) return;
      if(!isControlUnlocked()){
        showToast("설비 점검을 먼저 완료하세요. 제어 권한이 필요합니다.", "warn");
        return;
      }
      if(!el.longPressBtn || !longPressSpinnerEl || lpTimer) return;
      userWaitingLocal=true;
      lpStart=Date.now();
      lpLastSentSec=3;

      lpTimer=setInterval(()=>{
        const now=Date.now();
        const remain=LP_DURATION-(now-lpStart);
        const left=remain<0?0:remain;

        let ratio=(LP_DURATION-left)/LP_DURATION; if(ratio>1) ratio=1;
        const angle=Math.floor(360*ratio);
        longPressSpinnerEl.style.setProperty("--lp-angle",angle+"deg");

        let sec=Math.ceil(left/1000); if(sec<0) sec=0;
        if(confirmTitleEl){
          confirmTitleEl.textContent = sec>0 ? ("점화 시퀀스 진입까지 "+sec+"초") : "카운트다운 시작";
        }
        if(sec!==lpLastSentSec){
          lpLastSentSec=sec;
          sendCommand({http:"/precount?uw=1&cd="+left, ser:"PRECOUNT 1 "+left}, false);
        }

        if(left===0){
          clearInterval(lpTimer); lpTimer=null;
          resetLongPressVisual(); userWaitingLocal=false;
          if(confirmOverlayEl){ confirmOverlayEl.classList.add("hidden"); confirmOverlayEl.style.display="none"; }
          sendCommand({http:"/precount?uw=0&cd=0", ser:"PRECOUNT 0 0"}, false);
          sendCommand({http:"/countdown_start", ser:"COUNTDOWN"}, true);
          addLogLine("Countdown requested from dashboard (long-press).","CMD");
          showToast("카운트다운 요청을 보드에 전송했습니다. 신호/배선/주변을 계속 확인하세요. "+safetyLineSuffix(),"ignite");
        }
      },40);
    }

    function endHold(){
      if(!lpTimer) return;
      clearInterval(lpTimer); lpTimer=null;
      resetLongPressVisual();
      if(userWaitingLocal){
        const cdMs=(uiSettings?uiSettings.countdownSec:10)*1000;
        lpLastSentSec=Math.ceil(cdMs/1000);
        sendCommand({http:"/precount?uw=1&cd="+cdMs, ser:"PRECOUNT 1 "+cdMs}, false);
        showToast("롱프레스가 취소되었습니다. 주변 안전 확보 후 다시 시도하세요. "+safetyLineSuffix(),"info");
      }
    }

    // =====================
    // 설정/발사대
    // =====================
    function showSettings(){ if(el.settingsOverlay){ el.settingsOverlay.classList.remove("hidden"); el.settingsOverlay.style.display="flex"; } }
    function hideSettings(){ if(el.settingsOverlay){ el.settingsOverlay.classList.add("hidden"); el.settingsOverlay.style.display="none"; } }
    function showForceConfirm(){
      if(lockoutLatched){
        showToast("LOCKOUT 상태에서는 강제점화를 포함한 제어가 불가능합니다. 보드를 재시작하세요.", "error");
        return;
      }
      if(currentSt!==0){
        showToast("시퀀스 진행 중에는 강제 점화를 사용할 수 없습니다.", "warn");
        return;
      }
      if(!isControlUnlocked()){
        showToast("설비 점검을 먼저 완료하세요. 제어 권한이 필요합니다.", "warn");
        return;
      }
      if(forceOverlayEl){ forceOverlayEl.classList.remove("hidden"); forceOverlayEl.style.display="flex"; }
      showToast("강제 점화는 고위험 동작입니다. 마지막 확인 후 진행하세요. "+safetyLineSuffix(),"warn");
    }
    function hideForceConfirm(){ if(forceOverlayEl){ forceOverlayEl.classList.add("hidden"); forceOverlayEl.style.display="none"; } }
    function showLauncher(){
      if(lockoutLatched){
        showToast("LOCKOUT 상태에서는 제어가 불가능합니다.", "error");
        return;
      }
      if(!isControlUnlocked()){
        showToast("설비 점검을 먼저 완료하세요. 제어 권한이 필요합니다.", "warn");
        return;
      }
      if(launcherOverlayEl){ launcherOverlayEl.classList.remove("hidden"); launcherOverlayEl.style.display="flex"; }
    }
    function hideLauncher(){ if(launcherOverlayEl){ launcherOverlayEl.classList.add("hidden"); launcherOverlayEl.style.display="none"; } }
    function launcherStep(dir){ addLogLine("Launcher "+(dir==="up"?"UP":"DOWN")+" (UI only).","LAUNCHER"); }
    function startLauncherHold(dir){
      if(lockoutLatched){ showToast("LOCKOUT 상태에서는 제어가 불가능합니다.", "error"); return; }
      if(!isControlUnlocked()){ showToast("설비 점검을 먼저 완료하세요.", "warn"); return; }
      if(dir==="up"){
        if(!launcherUpHold){ launcherStep("up"); launcherUpHold=setInterval(()=>launcherStep("up"),200); }
      }else{
        if(!launcherDownHold){ launcherStep("down"); launcherDownHold=setInterval(()=>launcherStep("down"),200); }
      }
    }
    function stopLauncherHold(dir){
      if(dir==="up"){ if(launcherUpHold){ clearInterval(launcherUpHold); launcherUpHold=null; } }
      else { if(launcherDownHold){ clearInterval(launcherDownHold); launcherDownHold=null; } }
    }

    // =====================
    // CSV 유틸 (단일 파일 통합)
    // =====================
    function downloadTextAsFile(text, filename){
      const blob = new Blob([text], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function escapeCsvField(v){
      const s = (v==null) ? "" : String(v);
      if(/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }

    // =====================
    // 공통 명령 전송: Wi-Fi + (옵션) Serial
    // =====================
    async function sendCommand(cmd, logIt){
      if(lockoutLatched){
        const name = relayMaskName(lockoutRelayMask);
        showToast("LOCKOUT("+name+") 상태에서는 명령을 보낼 수 없습니다. 보드를 재시작하세요.", "error");
        return;
      }

      const API_BASE = (location.protocol === "http:" || location.protocol === "https:")
          ? ""
          : "http://192.168.4.1";

      if(cmd.http){
        const url = API_BASE ? (API_BASE + cmd.http) : cmd.http;
        const opt = API_BASE ? { mode:"no-cors", cache:"no-cache" } : { cache:"no-cache" };
        fetch(url, opt).catch(()=>{});
      }

      let serLine = cmd.ser ? String(cmd.ser).trim() : "";
      if(serLine && serLine[0] !== "/"){
        const parts = serLine.split(/\s+/);
        const head = (parts[0] || "").toUpperCase();

        if(head === "FORCE"){
          serLine = "/force_ignite";
        }else if(head === "COUNTDOWN"){
          serLine = "/countdown_start";
        }else if(head === "ABORT"){
          serLine = "/abort";
        }else if(head === "IGNITE"){
          serLine = "/ignite";
        }else if(head === "PRECOUNT"){
          const uw = (parts[1] != null) ? Number(parts[1]) : 0;
          const cd = (parts[2] != null) ? Number(parts[2]) : 0;
          serLine = "/precount?uw=" + (uw ? 1 : 0) + "&cd=" + Math.max(0, Math.min(30000, cd|0));
        }else if(head === "RS"){
          const v = (parts[1] != null) ? (Number(parts[1]) ? 1 : 0) : 0;
          serLine = "/set?rs=" + v;
        }else if(head === "IGS"){
          const v = (parts[1] != null) ? (Number(parts[1]) ? 1 : 0) : 0;
          serLine = "/set?igs=" + v;
        }else if(head === "IGNMS"){
          const ms = (parts[1] != null) ? (Number(parts[1])|0) : 5000;
          serLine = "/set?ign_ms=" + ms;
        }else if(head === "CDMS"){
          const ms = (parts[1] != null) ? (Number(parts[1])|0) : 10000;
          serLine = "/set?cd_ms=" + ms;
        }
      }

      if(serialEnabled && serialConnected && serialTxEnabled && serLine){
        await serialWriteLine(serLine);
      }

      if(logIt){
        addLogLine("CMD => " + (cmd.http || cmd.ser || "?"), "CMD");
      }
    }

    // =====================
    // DOM Ready
    // =====================
    document.addEventListener("DOMContentLoaded", async ()=>{
      // ✅ 스플래시 + 프리로드 먼저
      await runSplashAndPreload();

      el.toastContainer = document.getElementById("toastContainer");
      el.logView = document.getElementById("logView");
      el.connDot = document.getElementById("conn-dot");
      el.connText = document.getElementById("conn-text");
      el.statusPill = document.getElementById("statusPill");
      el.statusText = document.getElementById("statusText");
      el.countdown = document.getElementById("countdown");
      el.lockoutBg = document.getElementById("lockoutBg");
      el.kstTime = document.getElementById("kst-time");

      el.thrust = document.getElementById("thrust");
      el.pressure = document.getElementById("pressure");
      el.lt = document.getElementById("lt");

      el.loopPill = document.getElementById("loop-pill");
      el.snapHz   = document.getElementById("snap-hz");
      el.hxHz     = document.getElementById("hx-hz");
      el.cpuUs    = document.getElementById("cpu-us");

      el.modePill = document.getElementById("mode-pill");
      el.relaySafePill = document.getElementById("relay-safe-pill");

      el.sw = document.getElementById("sw");
      el.ic = document.getElementById("ic");
      el.relay = document.getElementById("relay");

      el.ignDelayDisplay = document.getElementById("ignDelayDisplay");
      el.burnDurationDisplay = document.getElementById("burnDurationDisplay");

      el.igniteBtn = document.getElementById("igniteBtn");
      el.abortBtn = document.getElementById("abortBtn");
      el.forceBtn = document.getElementById("forceIgniteBtn");
      el.copyLogBtn = document.getElementById("copyLogBtn");
      el.exportCsvBtn = document.getElementById("exportCsvBtn");

      el.controlsSettingsBtn = document.getElementById("controlsSettingsBtn");
      el.settingsOverlay = document.getElementById("settingsOverlay");
      el.settingsClose = document.getElementById("settingsClose");
      el.settingsSave = document.getElementById("settingsSave");
      el.unitThrust = document.getElementById("unitThrust");
      el.ignTimeInput = document.getElementById("ignTimeInput");
      el.countdownSecInput = document.getElementById("countdownSecInput");

      el.relaySafeToggle = document.getElementById("relaySafeToggle");
      el.igswitch = document.getElementById("igswitch");
      el.serialToggle = document.getElementById("serialToggle");
      el.serialRxToggle = document.getElementById("serialRxToggle");
      el.serialTxToggle = document.getElementById("serialTxToggle");
      el.serialStatus = document.getElementById("serialStatus");
      el.serialStatusText = document.getElementById("serialStatusText");

      el.launcherOpenBtn = document.getElementById("launcherOpenBtn");
      el.inspectionOpenBtn = document.getElementById("inspectionOpenBtn");
      el.inspectionOverlay = document.getElementById("inspectionOverlay");
      el.inspectionClose = document.getElementById("inspectionClose");
      el.inspectionResult = document.getElementById("inspectionResult");
      el.inspectionRetry = document.getElementById("inspectionRetry");
      el.inspectionStatusPill = document.getElementById("inspectionStatusPill");

      el.longPressBtn = document.getElementById("longPressBtn");

      // ✅ LOCKOUT modal elements
      el.lockoutOverlay = document.getElementById("lockoutOverlay");
      el.lockoutImg = document.getElementById("lockoutImg");
      el.lockoutTitle = document.getElementById("lockoutTitle");
      el.lockoutText = document.getElementById("lockoutText");
      el.lockoutNote = document.getElementById("lockoutNote");

      const helpLink=document.getElementById("controlsHelpLink");
      if(helpLink){ helpLink.addEventListener("click",()=>{ window.location.href="/help"; }); }

      loadSettings();
      applySettingsToUI();
      addLogLine("System ready. Waiting for commands.","READY");
      showToast("대시보드가 시작되었습니다. 연결 상태 확인 후 운용하세요. "+safetyLineSuffix(),"info");
      setLockoutVisual(false);
      resetInspectionUI();
      setButtonsFromState(currentSt, lockoutLatched);

      confirmOverlayEl=document.getElementById("confirmOverlay");
      longPressSpinnerEl=document.querySelector("#longPressBtn .longpress-spinner");
      confirmTitleEl=document.querySelector("#confirmOverlay .confirm-title");
      const confirmCancelBtn=document.getElementById("confirmCancel");

      forceOverlayEl=document.getElementById("forceOverlay");
      launcherOverlayEl=document.getElementById("launcherOverlay");

      const launcherCloseBtn=document.getElementById("launcherClose");
      const launcherUpBtn=document.getElementById("launcherUpModalBtn");
      const launcherDownBtn=document.getElementById("launcherDownModalBtn");

      if(el.relaySafeToggle){
        el.relaySafeToggle.addEventListener("change",()=>{
          relaySafeEnabled = !!el.relaySafeToggle.checked;
          uiSettings.relaySafe = relaySafeEnabled;
          saveSettings();
          updateRelaySafePill();
          sendCommand({http:"/set?rs="+(relaySafeEnabled?1:0), ser:"RS "+(relaySafeEnabled?1:0)}, true);
          showToast(relaySafeEnabled ? "RelaySafe가 ON입니다. 비정상 릴레이 HIGH 감지 시 LOCKOUT 됩니다." : "RelaySafe가 OFF입니다. (권장하지 않음)", relaySafeEnabled?"info":"warn");
        });
      }

      if(el.igswitch){
        el.igswitch.addEventListener("change",()=>{
          const val=el.igswitch.checked?1:0;
          uiSettings.igs = val;
          saveSettings();
          sendCommand({http:"/set?igs="+val, ser:"IGS "+val}, true);
          addLogLine("Igniter Safety Test toggled: "+(val?"ON":"OFF"),"SAFE");
          showToast(val ? ("Igniter Safety Test가 ON입니다. 이그나이터/배선에 주의하세요. "+safetyLineSuffix())
                       : ("Igniter Safety Test가 OFF입니다. 안전 상태로 유지하세요. "+safetyLineSuffix()),
                   val ? "warn" : "info");
        });
      }

      if(el.serialToggle){
        el.serialToggle.addEventListener("change",async ()=>{
          serialEnabled = !!el.serialToggle.checked;
          uiSettings.serialEnabled = serialEnabled;
          saveSettings();
          updateSerialPill();

          if(serialEnabled){
            await serialConnect();
          }else{
            await serialDisconnect();
          }
        });
      }
      if(el.serialRxToggle){
        el.serialRxToggle.addEventListener("change",()=>{
          serialRxEnabled = !!el.serialRxToggle.checked;
          uiSettings.serialRx = serialRxEnabled;
          saveSettings();
          showToast(serialRxEnabled ? "시리얼 수신 파싱 ON" : "시리얼 수신 파싱 OFF", "info");
        });
      }
      if(el.serialTxToggle){
        el.serialTxToggle.addEventListener("change",()=>{
          serialTxEnabled = !!el.serialTxToggle.checked;
          uiSettings.serialTx = serialTxEnabled;
          saveSettings();
          showToast(serialTxEnabled ? "시리얼 명령 전송 ON" : "시리얼 명령 전송 OFF", "info");
        });
      }

      if(el.igniteBtn){
        el.igniteBtn.addEventListener("click",()=>{
          if(currentSt===0) showConfirm();
        });
      }

      if(el.abortBtn){
        el.abortBtn.addEventListener("click",()=>{
          if(lockoutLatched){
            const name = relayMaskName(lockoutRelayMask);
            showToast("LOCKOUT("+name+") 상태에서는 ABORT도 불가능합니다. 보드를 재시작하세요.", "error");
            return;
          }
          sendCommand({http:"/abort", ser:"ABORT"}, true);
          showToast("ABORT 요청을 보드에 전송했습니다. 안전 확인 후 재시도하세요. "+safetyLineSuffix(),"error");
          hideConfirm();
        });
      }

      if(confirmCancelBtn){ confirmCancelBtn.addEventListener("click",()=>hideConfirm()); }

      if(el.longPressBtn){
        el.longPressBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); el.longPressBtn.setPointerCapture(e.pointerId); startHold(); });
        el.longPressBtn.addEventListener("pointerup",   (e)=>{ e.preventDefault(); endHold(); });
        el.longPressBtn.addEventListener("pointercancel",(e)=>{ e.preventDefault(); endHold(); });
      }

      if(el.inspectionOpenBtn){
        const openInspection=()=>{
          if(!connOk){
            showToast("보드와 연결 후 설비 점검을 실행하세요.", "warn");
            return;
          }
          showInspection();
        };
        el.inspectionOpenBtn.addEventListener("click", openInspection);
        el.inspectionOpenBtn.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openInspection(); }});
      }
      if(el.inspectionRetry){
        el.inspectionRetry.addEventListener("click",()=>runInspectionSequence());
      }
      if(el.inspectionClose){
        el.inspectionClose.addEventListener("click",()=>hideInspection());
      }
      if(el.inspectionOverlay){
        el.inspectionOverlay.addEventListener("click",(ev)=>{ if(ev.target===el.inspectionOverlay) hideInspection(); });
      }

      const forceBtn=el.forceBtn;
      const forceYes=document.getElementById("forceConfirmYes");
      const forceCancel=document.getElementById("forceConfirmCancel");
      if(forceBtn && forceYes && forceCancel){
        forceBtn.addEventListener("click",()=>showForceConfirm());
        forceCancel.addEventListener("click",()=>hideForceConfirm());
        forceYes.addEventListener("click",()=>{
          if(!isControlUnlocked()){
            showToast("설비 점검을 먼저 완료하세요. 제어 권한이 필요합니다.", "warn");
            return;
          }
          hideForceConfirm();
          sendCommand({http:"/force_ignite", ser:"FORCE"}, true);
          showToast("강제 점화 요청을 보드에 전송했습니다. 절대 접근하지 마세요. "+safetyLineSuffix(),"ignite");
        });
      }

      // ✅ LOCKOUT modal events
      const lockoutCloseBtn = document.getElementById("lockoutClose");
      const lockoutAckBtn = document.getElementById("lockoutAck");
      const lockoutCopyBtn = document.getElementById("lockoutCopy");
      if(lockoutCloseBtn) lockoutCloseBtn.addEventListener("click", ()=>hideLockoutModal());
      if(lockoutAckBtn) lockoutAckBtn.addEventListener("click", ()=>hideLockoutModal());
      if(el.lockoutOverlay){
        el.lockoutOverlay.addEventListener("click",(ev)=>{
          if(ev.target===el.lockoutOverlay) hideLockoutModal();
        });
      }
      if(lockoutCopyBtn){
        lockoutCopyBtn.addEventListener("click", ()=>{
          const name = relayMaskName(lockoutRelayMask);
          addLogLine("LOCKOUT modal acknowledged ("+name+"). Restart required.", "SAFE");
          showToast("LOCKOUT("+name+") 확인 처리(로그 기록). 보드를 재시작하세요.", "error", {duration:7000});
        });
      }

      if(el.copyLogBtn){
        el.copyLogBtn.addEventListener("click",()=>{
          const text=logLines.join("\n");
          if(navigator.clipboard && window.isSecureContext){
            navigator.clipboard.writeText(text).then(()=>{
              addLogLine("Log copied to clipboard.","INFO");
              showToast("로그가 클립보드에 복사되었습니다.","success");
            }).catch(()=>{
              addLogLine("Clipboard copy failed.","ERROR");
              showToast("클립보드 복사에 실패했습니다. 브라우저 권한을 확인하세요.","error");
            });
          }else{
            try{
              const ta=document.createElement("textarea");
              ta.value=text; ta.style.position="fixed"; ta.style.top="-9999px";
              document.body.appendChild(ta);
              ta.focus(); ta.select();
              document.execCommand("copy");
              document.body.removeChild(ta);
              addLogLine("Log copied to clipboard.","INFO");
              showToast("로그가 클립보드에 복사되었습니다.","success");
            }catch(e){
              addLogLine("Copy failed: "+e,"ERROR");
              showToast("복사에 실패했습니다. 브라우저 정책을 확인하세요.","error");
            }
          }
        });
      }

      if(el.exportCsvBtn){
        el.exportCsvBtn.addEventListener("click",()=>{
          const now = new Date();
          const pad = (n)=>String(n).padStart(2,"0");
          const fnameSuffix =
            now.getFullYear().toString()+
            pad(now.getMonth()+1)+pad(now.getDate())+"_"+pad(now.getHours())+pad(now.getMinutes())+pad(now.getSeconds());
          const filename = "ALTIS_FLASH_DAQ_" + fnameSuffix + "_data.csv";

          const hasIgnitionWindow =
            ignitionAnalysis.hasData &&
            ignitionAnalysis.ignStartMs!=null &&
            ignitionAnalysis.thresholdMs!=null &&
            ignitionAnalysis.lastAboveMs!=null;

          const windowStartMs = hasIgnitionWindow ? (ignitionAnalysis.thresholdMs - IGN_PRE_WINDOW_MS) : null;
          const windowEndMs   = hasIgnitionWindow ? (ignitionAnalysis.lastAboveMs + IGN_POST_WINDOW_MS) : null;

          const delayVal = (ignitionAnalysis.delaySec!=null) ? ignitionAnalysis.delaySec.toFixed(3) : "";
          const durVal   = (ignitionAnalysis.durationSec!=null) ? ignitionAnalysis.durationSec.toFixed(3) : "";

          let csv = "";
          csv += [
            "type",
            "time_iso",
            "tag",
            "message",
            "thrust_kgf",
            "pressure_v",
            "loop_ms",
            "hx_hz",
            "cpu_us",
            "switch",
            "ign_ok",
            "relay",
            "igs_mode",
            "state",
            "cd_ms",
            "rel_time_s",
            "is_ignition_window",
            "ignition_delay_s",
            "effective_burn_s",
            "threshold_kgf"
          ].join(",") + "\n";

          csv += [
            "IGN_SUMMARY",
            escapeCsvField(now.toISOString()),
            "",
            escapeCsvField(hasIgnitionWindow ? "Ignition window detected" : "No ignition window"),
            "", "", "", "", "", "", "", "", "", "", "",
            "",
            hasIgnitionWindow ? "1" : "0",
            delayVal,
            durVal,
            IGN_THRUST_THRESHOLD.toFixed(3)
          ].join(",") + "\n";

          for(const e of eventLog){
            csv += [
              "EVENT",
              escapeCsvField(e.time),
              escapeCsvField(e.tag || ""),
              escapeCsvField(e.message || ""),
              "", "", "", "", "", "", "", "", "", "", "",
              "",
              "0",
              "", "", ""
            ].join(",") + "\n";
          }

          const t0ms = (logData && logData.length) ? Date.parse(logData[0].time) : null;

          for(const row of logData){
            const ms = Date.parse(row.time);
            const rel = (t0ms!=null && isFinite(ms)) ? ((ms - t0ms)/1000).toFixed(3) : "";
            const inWin = (hasIgnitionWindow && isFinite(ms) && ms>=windowStartMs && ms<=windowEndMs) ? 1 : 0;

            csv += [
              "RAW",
              escapeCsvField(row.time),
              "",
              "",
              Number(row.t).toFixed(3),
              Number(row.p).toFixed(3),
              (row.lt ?? ""),
              (row.hz ?? ""),
              (row.ct ?? ""),
              (row.s  ?? 0),
              (row.ic ?? 0),
              (row.r  ?? 0),
              (row.gs ?? 0),
              (row.st ?? 0),
              (row.cd ?? 0),
              rel,
              String(inWin),
              "", "", ""
            ].join(",") + "\n";
          }

          downloadTextAsFile(csv, filename);

          addLogLine("CSV exported (single file): " + filename, "INFO");
          showToast("CSV를 1개 파일로 내보냈습니다. (IGN_SUMMARY + EVENT + RAW)", "success");
        });
      }

      const navBtns=document.querySelectorAll(".settings-nav-btn");
      const panels=document.querySelectorAll(".settings-panel");
      navBtns.forEach(btn=>{
        btn.addEventListener("click",()=>{
          const target=btn.dataset.target;
          navBtns.forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          panels.forEach(p=>p.classList.toggle("active",p.dataset.panel===target));
        });
      });

      if(el.controlsSettingsBtn) el.controlsSettingsBtn.addEventListener("click",()=>showSettings());
      if(el.settingsClose) el.settingsClose.addEventListener("click",()=>hideSettings());
      if(el.settingsOverlay){
        el.settingsOverlay.addEventListener("click",(ev)=>{ if(ev.target===el.settingsOverlay) hideSettings(); });
      }

      updateInspectionAccess();

      if(el.settingsSave && el.unitThrust && el.ignTimeInput && el.countdownSecInput){
        el.settingsSave.addEventListener("click",async ()=>{
          const before=Object.assign({}, uiSettings || defaultSettings());

          uiSettings.thrustUnit = el.unitThrust.value || "kgf";

          let ignSec=parseInt(el.ignTimeInput.value,10);
          if(isNaN(ignSec)||ignSec<1) ignSec=1;
          if(ignSec>10) ignSec=10;
          el.ignTimeInput.value=ignSec;
          uiSettings.ignDurationSec=ignSec;

          let cdSec=parseInt(el.countdownSecInput.value,10);
          if(isNaN(cdSec)||cdSec<3) cdSec=3;
          if(cdSec>30) cdSec=30;
          el.countdownSecInput.value=cdSec;
          uiSettings.countdownSec=cdSec;

          uiSettings.relaySafe = relaySafeEnabled;
          uiSettings.igs = el.igswitch ? (el.igswitch.checked?1:0) : (uiSettings.igs||0);
          uiSettings.serialEnabled = serialEnabled;
          uiSettings.serialRx = serialRxEnabled;
          uiSettings.serialTx = serialTxEnabled;

          saveSettings();
          applySettingsToUI();

          await sendCommand({http:"/set?ign_ms="+(ignSec*1000), ser:"IGNMS "+(ignSec*1000)}, false);
          await sendCommand({http:"/set?cd_ms="+(cdSec*1000),  ser:"CDMS "+(cdSec*1000)}, false);

          if(before.thrustUnit!==uiSettings.thrustUnit){
            showToast("추력 단위가 "+before.thrustUnit+" → "+uiSettings.thrustUnit+" 로 변경되었습니다. 표시 단위만 변경됩니다. "+safetyLineSuffix(),"info");
          }
          if(before.ignDurationSec!==uiSettings.ignDurationSec){
            showToast("점화 시간이 "+before.ignDurationSec+"s → "+uiSettings.ignDurationSec+"s 로 변경되었습니다. 과열/인가 시간에 주의하세요. "+safetyLineSuffix(),"warn");
          }
          if(before.countdownSec!==uiSettings.countdownSec){
            showToast("카운트다운 시간이 "+before.countdownSec+"s → "+uiSettings.countdownSec+"s 로 변경되었습니다. 인원 통제 시간을 충분히 두세요. "+safetyLineSuffix(),"warn");
          }

          addLogLine("Settings updated: thrustUnit="+uiSettings.thrustUnit+", ignDuration="+ignSec+"s, countdown="+cdSec+"s", "CFG");
          hideSettings();
          redrawCharts();

          if(serialEnabled && !serialConnected){
            await serialConnect();
          }
          if(!serialEnabled && serialConnected){
            await serialDisconnect();
          }
        });
      }

      if(el.launcherOpenBtn && launcherOverlayEl){
        el.launcherOpenBtn.addEventListener("click",()=>showLauncher());
        el.launcherOpenBtn.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); showLauncher(); }});
      }
      if(launcherCloseBtn){ launcherCloseBtn.addEventListener("click",()=>hideLauncher()); }
      if(launcherOverlayEl){ launcherOverlayEl.addEventListener("click",(ev)=>{ if(ev.target===launcherOverlayEl) hideLauncher(); }); }

      if(launcherUpBtn || launcherDownBtn){
        const startEvents=["mousedown","touchstart"];
        const endEvents=["mouseup","mouseleave","touchend","touchcancel"];

        if(launcherUpBtn){
          startEvents.forEach(evName=>{
            launcherUpBtn.addEventListener(evName,(ev)=>{ ev.preventDefault(); launcherUpBtn.classList.add("pressed"); startLauncherHold("up"); },{passive:false});
          });
          endEvents.forEach(evName=>{
            launcherUpBtn.addEventListener(evName,(ev)=>{ ev.preventDefault(); launcherUpBtn.classList.remove("pressed"); stopLauncherHold("up"); },{passive:false});
          });
        }

        if(launcherDownBtn){
          startEvents.forEach(evName=>{
            launcherDownBtn.addEventListener(evName,(ev)=>{ ev.preventDefault(); launcherDownBtn.classList.add("pressed"); startLauncherHold("down"); },{passive:false});
          });
          endEvents.forEach(evName=>{
            launcherDownBtn.addEventListener(evName,(ev)=>{ ev.preventDefault(); launcherDownBtn.classList.remove("pressed"); stopLauncherHold("down"); },{passive:false});
          });
        }
      }

      const zoomOutBtn=document.getElementById("chartZoomOut");
      const zoomInBtn=document.getElementById("chartZoomIn");
      const chartLeft=document.getElementById("chartLeft");
      const chartRight=document.getElementById("chartRight");
      const chartLive=document.getElementById("chartLive");

      if(zoomOutBtn){
        zoomOutBtn.addEventListener("click",()=>{ chartView.window=Math.min(MAX_POINTS,Math.round(chartView.window*1.4)); autoScrollChart=false; redrawCharts(); });
      }
      if(zoomInBtn){
        zoomInBtn.addEventListener("click",()=>{ chartView.window=Math.max(10,Math.round(chartView.window*0.7)); autoScrollChart=false; redrawCharts(); });
      }
      if(chartLeft){
        chartLeft.addEventListener("click",()=>{ autoScrollChart=false; chartView.start=(chartView.start||0)-Math.round(chartView.window*0.2); redrawCharts(); });
      }
      if(chartRight){
        chartRight.addEventListener("click",()=>{ autoScrollChart=false; chartView.start=(chartView.start||0)+Math.round(chartView.window*0.2); redrawCharts(); });
      }
      if(chartLive){
        chartLive.addEventListener("click",()=>{ autoScrollChart=true; redrawCharts(); });
      }

      attachTouch("thrustChart");
      attachTouch("pressureChart");
      window.addEventListener("resize",()=>{ redrawCharts(); });

      updateData().finally(()=>{ pollLoop(); });
      updateSerialPill();
    });
  </script>

</body>
</html>
